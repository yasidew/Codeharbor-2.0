{% extends 'base.html' %}
{% load static %}

{% block title %}Statistical Analysis Results{% endblock %}

{% block sidebar %}
    <div class="sidebar" data-color="black">
        <div class="sidebar-wrapper">
            <div class="logo">
                <a href="http://127.0.0.1:8000" class="simple-text logo-mini">
                    <img src="{% static 'images/code-harbor-logo.png' %}" alt="Code Harbor Logo" width="30">
                </a>
                <a href="http://127.0.0.1:8000" class="simple-text logo-normal">Code Harbor</a>
            </div>
            <ul class="nav">
                <li><a href="#"><i class="bi bi-gear"></i>
                    <p>Settings</p></a></li>
                <li><a href="{% url 'guidelines' %}"><i class="bi-card-list"></i>
                    <p>View WCC Guidelines</p></a></li>
                <li><a href="{% url 'calculate_complexity_line_by_line' %}"><i class="fa-brands fa-java"></i>
                    <p>Java WCC Calculator</p></a></li>
                <li><a href="{% url 'calculate_complexity_line_by_line_csharp' %}"><i
                        class="fa-brands fa-microsoft"></i>
                    <p>C# WCC Calculator</p></a></li>
                <li><a href="{% url 'calculate_complexity-excel' %}"><i class="bi bi-graph-up"></i>
                    <p>Statical Analysis</p></a></li>
                <li><a href="http://127.0.0.1:8000/api/logout"><i class="bi bi-box-arrow-right"></i>
                    <p>Logout</p></a></li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block content %}
    <style>
        /* Page Styling */
        .container-custom {
            max-width: 1100px;
            margin: auto;
            background-color: #161b22;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        /* Headings */
        h1, h2 {
            color: #58a6ff;
            font-weight: bold;
        }

        /* Tables */
        .table {
            border-radius: 8px;
            overflow: hidden;
        }

        .table thead {
            background-color: #21262d;
            color: #c9d1d9;
        }

        .table tbody tr {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Image Styling */
        .analysis-img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
        }

        .custom-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: green;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .show-toast {
            opacity: 1;
        }

    </style>

    <div class="container mt-5">
        <h1 class="text-center">Statistical Analysis Results</h1>

        <p>This page presents the statistical analysis of Weighted Code Complexity (WCC) and its relationship with
            various software quality metrics such as Complexity, Maintainability, and Readability. The analysis includes
            correlation coefficients, scatter plots, clustering, and boxplots.</p>

        <!-- Correlation Analysis -->
        <section class="my-5">
            <h2>Correlation Analysis</h2>

            <div class="mb-4 text-white" style="background-color:#21262d; padding: 20px; border-radius: 10px;">
                <h5 style="color: #58a6ff;"><strong>📘 Understanding Correlation Coefficients</strong></h5>
                <p><strong>Pearson Correlation Coefficient (r):</strong></p>
                <ul>
                    <li><code>r</code> ranges from <strong>-1</strong> to <strong>+1</strong></li>
                    <li>Closer to <strong>+1</strong> → Strong positive linear relationship</li>
                    <li>Closer to <strong>-1</strong> → Strong negative linear relationship</li>
                    <li><code>0</code> → No linear correlation</li>
                </ul>
                <p><strong>P-value:</strong></p>
                <ul>
                    <li>Indicates <strong>statistical significance</strong> of the correlation</li>
                    <li>P-value <strong>&lt; 0.05</strong> means the result is statistically significant</li>
                    <li>Very small values like <code>0.0006</code> indicate <strong>high confidence</strong> in the
                        correlation
                    </li>
                </ul>
            </div>
            <h4>These tables display the Pearson Correlation and Spearman Correlation between WCC and other software
                quality metrics(Maintainability, Readability & Developer Perspective Complexity).</h4>

            <div class="table-responsive">
                <h4>📌 Pearson Correlation Table</h4>
                <table class="table table-bordered text-white">
                    <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Pearson Correlation</th>
                        <th>Pearson p-value</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for column, result in pearson_results.items %}
                        <tr>
                            <td>{{ column }}</td>
                            <td>{{ result.correlation }}</td>
                            <td>{{ result.p_value }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>

                <ul>
                    <li>Pearson Correlation measures the linear relationship between WCC and the given metrics.</li>
                    <li>Complexity (0.7295) → WCC increases as Complexity increases (Strong positive correlation).</li>
                    <li>Maintainability (-0.3357) → WCC increases as Maintainability decreases (Moderate negative
                        correlation).
                    </li>
                    <li>Readability (-0.3333) → WCC increases as Readability decreases (Moderate negative
                        correlation).
                    </li>
                </ul>
                <p style="color: #0e84f8; font-size: 16px">All P-values are very small → These correlations are
                    statistically
                    significant.</p>
            </div>

            <div class="table-responsive mt-4">
                <h4>📌 Spearman Correlation Table</h4>
                <table class="table table-bordered text-white">
                    <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Spearman Correlation</th>
                        <th>Spearman p-value</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for column, result in spearman_results.items %}
                        <tr>
                            <td>{{ column }}</td>
                            <td>{{ result.correlation }}</td>
                            <td>{{ result.p_value }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>

                <ul>
                    <li>Spearman Correlation is a rank-based correlation that measures relationships using a monotonic
                        function.
                    </li>
                    <li>Complexity (0.7717) has a Strong positive correlation relationships with WCC.</li>
                    <li>Maintainability (-0.3636) and Readability (-0.3847) show Moderate negative correlation
                        relationships with WCC.
                    </li>
                </ul>
                <p style="color: #0e84f8; font-size: 16px">All P-values are very small → These correlations are
                    statistically
                    significant.</p>
            </div>
        </section>

        <!-- Scatter Plots -->
        <section class="my-5">
            <h2>Scatter Plots</h2>
            <h4>Scatter plots visualize the relationship between WCC and various software quality metrics.</h4>
            {% for column, plot_path in scatter_plots.items %}
                <div class="mb-4">
                    <h3 style="color: #0e84f8">📌{{ column }} vs WCC</h3>
                    <img src="{{ MEDIA_URL }}/media/scatter_{{ column }}.png" alt="Scatter plot for {{ column }}"
                         class="analysis-img">

                    {% if column == "Complexity" %}
                        <ul>
                            <li>Shows how Complexity changes as WCC increases.</li>
                            <li>Red trendline indicates a positive correlation (higher WCC tends to have higher
                                Complexity).
                            </li>
                            <li>The distribution of points shows a strong relationship, confirming the correlation table
                                results.
                            </li>
                        </ul>
                    {% elif column == "Maintainability" %}
                        <ul>
                            <li>Shows how Maintainability changes as WCC increases.</li>
                            <li>Red trendline shows a negative correlation (higher WCC tends to have lower
                                Maintainability).
                            </li>
                            <li>This means complex code is generally harder to maintain.</li>
                        </ul>
                    {% elif column == "Readability" %}
                        <ul>
                            <li>Shows how Readability changes as WCC increases.</li>
                            <li>Red trendline shows a negative correlation (higher WCC tends to have lower
                                Readability).
                            </li>
                            <li>Complex code is harder to read and understand.</li>
                        </ul>
                    {% endif %}
                </div>
            {% endfor %}
        </section>

        <!-- Cluster Centers -->
        <section class="my-5">
            <h2>Cluster Centers (Thresholds)</h2>
            <p>Clustering was performed to determine two complexity levels: **Low Complexity** and **High Complexity**.
            </p>
            <h4 style="color: green"><strong>Low Complexity:</strong> {{ low_center }}</h4>
            <h4 style="color: red"><strong>High Complexity:</strong> {{ high_center }}</h4>
            <p>These values help define complexity levels and categorize methods into <b>Low, Medium, and High
                Complexity.</b></p>
        </section>

        <section class="my-5">
            <h2>WCC Clustering and Thresholds Graph </h2>
            <ul>
                <li>This scatter plot clusters methods based on their WCC values.</li>
                <li>Orange and blue dots represent two clusters (Low & High complexity).</li>
                <li>The dotted lines represent threshold values, visually separating low and high complexity
                    components.
                </li>
            </ul>
            <img src="{{ MEDIA_URL }}/media/wcc_clustering.png" alt="Boxplot of WCC by Complexity Level"
                 class="analysis-img">
        </section>

        <!-- Boxplot -->
        <section class="my-5">
            <h2>Boxplot of WCC by Complexity Level</h2>
            <ul>
                <li>A boxplot represents the distribution of WCC values for high and low complexity groups.</li>
                <li>The High Complexity group has higher WCC values with a larger spread.</li>
                <li>The Low Complexity group has lower WCC values with a more compact distribution.</li>
            </ul>
            <img src="{{ MEDIA_URL }}/media/boxplot_with_thresholds.png" alt="Boxplot of WCC by Complexity Level"
                 class="analysis-img">
        </section>
    </div>

    <div id="customToast" class="custom-toast"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("🔥 DOM fully loaded. Checking for content...");

            // Check if complexities exist in the DOM
            const complexitiesContainer = document.querySelector(".container");
            if (complexitiesContainer) {
                console.log("✅ Complexity details found!");

                // Call the toast function when all details are loaded
                setTimeout(() => {
                    console.log("⏳ Calling showCustomToast()...");
                    showCustomToast("✅ Statistical Analysis Successfully!");
                }, 1000); // Add a small delay to simulate loading
            } else {
                console.warn("⚠️ No complexity details found. Skipping toast.");
            }
        });

        function showCustomToast(message) {
            console.log("🔥 showCustomToast() function called!");

            const toast = document.getElementById('customToast');
            if (!toast) {
                console.error("❌ ERROR: Toast element not found!");
                return;
            }

            console.log("✅ Toast element found!");

            // Ensure it's visible before applying animation
            toast.style.display = 'block';
            setTimeout(() => {
                toast.textContent = message;
                toast.classList.add('show-toast');
                console.log("🎉 Toast is now visible!");
            }, 10); // Small delay to trigger animation

            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show-toast');
                console.log("⌛ Hiding toast...");
                setTimeout(() => {
                    toast.style.display = 'none';
                    console.log("❌ Toast is now hidden.");
                }, 500); // Matches the CSS transition
            }, 3000);
        }
    </script>
{% endblock %}