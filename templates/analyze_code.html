{% extends 'base.html' %}

{% block content %}
<h1 class="text-center mb-4">AI Code Analyzer</h1>

{% if error %}
<div class="alert alert-danger text-center">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
</div>
{% endif %}
<!-- Include Toast Messages from code_analysis directory -->
{% include 'code_analysis/toast_messages.html' %}

<div id="loading-spinner" style="
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        z-index: 1000;
        flex-direction: column;
    ">
    <div class="dots-loader">
        <span class="red"></span>
        <span class="yellow"></span>
        <span class="green"></span>
        <span class="blue"></span>
    </div>
    <p>Analyzing Code... Please Wait</p>
</div>

<nav class="mb-4">
    <ul class="nav justify-content-center">
        <li class="nav-item">
            <a class="nav-link btn btn-outline-primary" href="{% url 'java_code_analysis' %}">Java Code Analyzer</a>
        </li>
{#        <li class="nav-item">#}
{#            <a class="nav-link btn btn-outline-primary" href="{% url 'python_code_analysis' %}">Python Code Analyzer</a>#}
{#        </li>#}
{#        <li class="nav-item">#}
{#            <a class="nav-link btn btn-outline-primary" href="{% url 'js_code_analyser' %}">JavaScript Analyzer</a>#}
{#        </li>#}
    </ul>
</nav>

<div class="container">
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {#            <div class="mb-3">#}
        {#                <label for="fileInput" class="form-label">Upload File(s):</label>#}
        {#                <input type="file" name="files" id="fileInput" class="form-control mb-3" multiple>#}
        {#            </div>#}
        <div class="mb-3">
            <label for="fileInput" class="form-label fw-bold">
                <i class="fas fa-file-upload"></i> Upload File(s):
            </label>

            <div class="upload-container text-center">
                <label for="fileInput" class="upload-box d-flex align-items-center justify-content-center">
                    <div class="text-center">
                        <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                        <p class="mt-2">Click or Drag & Drop files here</p>
                    </div>
                    <input type="file" name="files" id="fileInput" class="form-control d-none" multiple>
                </label>
                <div id="fileNameDisplay" class="mt-2 text-muted"></div>
            </div>
        </div>

        <!-- Button to Open Modal -->
        <div class="text-center mb-3">
            <button id="githubBtn" class="btn btn-lg btn-github">
                <i class="fab fa-github"></i> Import from GitHub
            </button>
        </div>


        {#            <div class="mb-3">#}
        {#                <label class="form-label">Paste Code Below:</label>#}
        {#                <div id="monaco-container" style="height: 400px; border: 1px solid #ccc;"></div>#}
        {#                <textarea id="codeEditor" name="code" style="display: none;">{{ code }}</textarea>#}
        {#            </div>#}
        <div class="mb-3">
            <label class="form-label fw-bold">
                <i class="fas fa-file-code"></i> Select File to Analyze:
            </label>

            <div class="input-group">
                <select id="fileSelector" class="form-select custom-dropdown">
                    <option selected disabled>Select a file</option>
                </select>
                <span class="input-group-text bg-primary text-white">
                        <i class="fas fa-folder-open"></i>
                    </span>
            </div>

            <!-- Monaco Editor Container -->
            <div id="monaco-container" class="mt-3 rounded shadow-sm"></div>
            <textarea id="codeEditor" name="code" style="display: none;">{{ code }}</textarea>
        </div>

        <!-- Initialize Monaco Editor -->
        <script>
            require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' }});
            require(["vs/editor/editor.main"], function () {
                window.editor = monaco.editor.create(document.getElementById("monaco-container"), {
                    value: "", // Start empty
                    language: "python",
                    theme: "vs-dark"
                });
            });
        </script>


        <div class="text-center mt-3">
            <button type="submit" class="btn btn-lg btn-primary px-4 py-2 shadow-sm rounded-pill" style="background: linear-gradient(135deg, #007bff, #0056b3); border: none; font-weight: bold; transition: 0.3s;">
                <i class="fas fa-search"></i> Analyze Code
            </button>
        </div>

    </form>

    <!-- GitHub Repository Modal (Initially Hidden) -->
    <div id="githubModal" class="github-modal">
        <div class="github-modal-content">
            <h4 class="text-center"><i class="fab fa-github"></i> Import from GitHub</h4>
            <p class="text-center">Enter the GitHub repository URL to analyze.</p>

            <input type="text" id="githubRepoUrl" class="form-control"
                   placeholder="Enter GitHub Repo URL (e.g., https://github.com/user/repo)">

            <div class="text-center mt-3">
                <button id="analyzeGithubBtn" class="btn">Fetch</button>
                <button id="closeGithubBtn" class="btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden Form to Submit GitHub URL -->
    <form id="githubForm" method="POST" action="{% url 'analyze_code' %}">
        {% csrf_token %}
        <input type="hidden" name="github_url" id="githubRepoInput">
    </form>



    <div id="analysis-results" class="mt-4">
        {% if suggestions %}
        <h2 class="text-center mb-4">Analysis Results:</h2>
        <div class="recommendation-container scrollable-container">
            {% for suggestion in suggestions %}
            <div class="code-block">
                {#                            <strong>üìÇ File Name: {{ suggestion.file_name }}</strong> <br> <!-- ‚úÖ Show File Name -->#}
                <strong>üîπ Code With Issue:</strong>
                <pre>{{ suggestion.code }}</pre>
            </div>
            <div class="suggestion-block">
                <strong>üí° Suggestion:</strong>
                <pre>{{ suggestion.suggestion | safe }}</pre>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center">No recommendations available. Paste or upload code to analyze.</p>
        {% endif %}
    </div>


    {#        <div id="analysis-results" class="mt-4">#}
    {#            {% if suggestions %}#}
    {#                <h2 class="text-center mb-4">Analysis Results:</h2>#}
    {#                <div class="recommendation-container scrollable-container">#}
        {#                    {% for suggestion in suggestions %}#}
        {#                        <div class="code-block">#}
            {#                            <strong>Code With Issue:</strong>#}
            {#                            <pre>{{ suggestion.code }}</pre>#}
            {#                        </div>#}
        {#                        <div class="suggestion-block">#}
            {#                            <strong>Suggestion:</strong>#}
            {#                            <pre>{{ suggestion.suggestion | safe}}</pre>#}
            {#                        </div>#}
        {#                    {% endfor %}#}
        {#                </div>#}
    {#            {% else %}#}
    {#                <p class="text-center">No recommendations available. Paste or upload code to analyze.</p>#}
    {#            {% endif %}#}
    {#        </div>#}

    <!-- Summary Report Section -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="summary-panel p-3 shadow-sm rounded">
                    <h3 class="text-center">Code Analysis Summary Report</h3><br>
                    <p><strong style="color: white;">Total Code Segments Analyzed:</strong> {{ summary.total_snippets }}</p>
                    <p><strong style="color: white;">Total Suggestions:</strong> {{ summary.total_suggestions }}</p>
                    <p><strong style="color: white;">Total Code Lines Processed:</strong> {{ summary.total_lines }}</p>

                    <!-- Code Complexity Metrics Section -->
                    {% include 'code_analysis/complexity_metrics.html' %}



                    <hr>
                    <h4>Categories</h4>
                    {#                        <ul class="list-group">#}
                    {#                            {% for category, count in summary.categories.items %}#}
                    {#                                <li class="list-group-item d-flex justify-content-between align-items-center">#}
                        {#                                    {{ category }}#}
                        {#                                    <span class="badge bg-primary rounded-pill">{{ count }}</span>#}
                        {#                                </li>#}
                    {#                            {% endfor %}#}
                    {#                        </ul>#}
                    <div class="category-container">
                        <ul class="list-group">
                            {% for category, count in summary.categories.items %}
                            <li class="list-group-item d-flex justify-content-between align-items-center category-toggle"
                                data-category="{{ category }}">
                                {{ category }}
                                <span class="badge bg-primary rounded-pill">{{ count }}</span>
                            </li>
                            <div class="category-details" id="{{ category|slugify }}-details" style="display: none;">
                                {% for suggestion in suggestions %}
                                {% if suggestion.category == category %}
                                <div class="code-block">
                                    <strong>Code With Issue (Line {{ suggestion.line }}):</strong>
                                    <pre>{{ suggestion.code }}</pre>
                                </div>
                                <div class="suggestion-block">
                                    <strong>Suggestion:</strong>
                                    <pre>{{ suggestion.suggestion | safe}}</pre>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </ul>
                    </div>


                    <br><hr>
                    <h4>Severity Levels</h4>
                    <div class="severity-container">
                        <ul class="list-group">
                            {% for level, count in summary.severity.items %}
                            <li class="list-group-item d-flex justify-content-between align-items-center severity-toggle"
                                data-severity="{{ level }}">
                                {{ level }}
                                <span class="badge bg-warning rounded-pill">{{ count }}</span>
                            </li>
                            <div class="severity-details" id="{{ level|lower }}-details" style="display: none;">
                                {% for suggestion in suggestions %}
                                {% if suggestion.severity == level %}
                                <div class="code-block">
                                    <strong>Code With Issue (Line {{ suggestion.line }}):</strong>
                                    <pre>{{ suggestion.code }}</pre>
                                </div>
                                <div class="suggestion-block">
                                    <strong>Suggestion:</strong>
                                    <pre>{{ suggestion.suggestion | safe}}</pre>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Issue Category Distribution -->
            <div class="col-md-6">
                <div class="chart-container p-3 shadow-sm rounded">
                    <h4 class="text-center">Code Analysis Issue Distribution</h4>
                    <canvas id="categoryChart" width="400" height="400"></canvas>
                </div><br>
                <div class="chart-container p-3 shadow-sm rounded">
                    <h4 class="text-center">Severity Level Distribution</h4>
                    <canvas id="severityChart" width="400" height="400" ></canvas>
                </div>
                <div class="chart-container p-3 shadow-sm rounded mt-4">
                    <h4 class="text-center">Code Complexity Metrics</h4>
                    <canvas id="complexityChart" width="400" height="400"></canvas>
                </div>
{#                <div class="chart-container p-3 shadow-sm rounded mt-4">#}
{#                    <h4 class="text-center">Code Complexity Radar Chart</h4>#}
{#                    <canvas id="complexityRadarChart" width="400" height="400"></canvas>#}
{#                </div>#}
                <div class="text-center mt-3">
                    <a href="{% url 'export_excel' %}" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Download Excel Report
                    </a>
                </div>

                <!-- üî• Trend Analysis: Compare Against Previous Runs -->
                {#                    <div class="chart-container p-3 shadow-sm rounded mt-4">#}
                {#                        <h4 class="text-center">üìä Code Quality Progress Over Time</h4>#}
                {#                        {% if previous_analysis %}#}
                {#                            <table class="table table-bordered text-center">#}
                    {#                                <thead>#}
                    {#                                <tr class="table-primary">#}
                        {#                                    <th>üìä Metric</th>#}
                        {#                                    <th>üìÜ Previous Run</th>#}
                        {#                                    <th>üìÜ Current Run</th>#}
                        {#                                    <th>üìâüìà Trend</th>#}
                        {#                                </tr>#}
                    {#                                </thead>#}
                    {#                                <tbody>#}
                    {#                                <tr>#}
                        {#                                    <td>‚öôÔ∏è Complexity Score</td>#}
                        {#                                    <td>{{ previous_analysis.complexity_score }}</td>#}
                        {#                                    <td>{{ summary.complexity_metrics.complexity_score }}</td>#}
                        {#                                    <td>#}
                            {#                                        {% if previous_analysis.complexity_score > summary.complexity_metrics.complexity_score %}#}
                            {#                                            ‚úÖ Improved üìâ#}
                            {#                                        {% else %}#}
                            {#                                            ‚ùå Increased üìà#}
                            {#                                        {% endif %}#}
                            {#                                    </td>#}
                        {#                                </tr>#}
                    {#                                <tr>#}
                        {#                                    <td>üîÑ Duplicate Code</td>#}
                        {#                                    <td>{{ previous_analysis.duplicate_code_percentage }}%</td>#}
                        {#                                    <td>{{ summary.complexity_metrics.duplicate_code_percentage }}%</td>#}
                        {#                                    <td>#}
                            {#                                        {% if previous_analysis.duplicate_code_percentage > summary.complexity_metrics.duplicate_code_percentage %}#}
                            {#                                            ‚úÖ Reduced üìâ#}
                            {#                                        {% else %}#}
                            {#                                            ‚ùå Increased üìà#}
                            {#                                        {% endif %}#}
                            {#                                    </td>#}
                        {#                                </tr>#}
                    {#                                <tr>#}
                        {#                                    <td>üõ° Security Issues</td>#}
                        {#                                    <td>{{ previous_analysis.security_issues }}</td>#}
                        {#                                    <td>{{ summary.complexity_metrics.security_issues }}</td>#}
                        {#                                    <td>#}
                            {#                                        {% if previous_analysis.security_issues > summary.complexity_metrics.security_issues %}#}
                            {#                                            ‚úÖ Fewer Issues üìâ#}
                            {#                                        {% else %}#}
                            {#                                            ‚ùå More Issues üìà#}
                            {#                                        {% endif %}#}
                            {#                                    </td>#}
                        {#                                </tr>#}
                    {#                                </tbody>#}
                    {#                            </table>#}
                {#                        {% else %}#}
                {#                            <p class="text-center text-muted">No previous analysis available for comparison.</p>#}
                {#                        {% endif %}#}
                {#                    </div>#}

                {#                    <div class="container mt-4">#}
                {#                        <h3 class="text-center">üì• Download Report</h3>#}
                {#                        <div class="text-center">#}
                    {#                            <a href="{% url 'generate_pdf_report' %}" class="btn btn-danger">#}
                        {#                                <i class="fas fa-file-pdf"></i> Download PDF Report#}
                        {#                            </a>#}
                    {#                        </div>#}
                {#                    </div>#}


            </div>
            <!-- Severity Level Distribution -->
            {#                <div class="col-md-6 ">#}
            {#                    <div class="chart-container p-3 shadow-sm rounded">#}
                {#                        <h4 class="text-center">Severity Level Distribution</h4>#}
                {#                        <canvas id="severityChart" width="400" height="400" ></canvas>#}
                {#                    </div>#}
            {#                </div>#}
        </div>
        <!-- Developer Guideline Section -->
        {% if final_guideline %}
        <div class="container mt-5">
            <div class="guideline-panel p-4 shadow-lg rounded text-center">
                <h3 class="guideline-title mb-3">
                    <i class="fas fa-lightbulb"></i> Final Coding Guideline
                </h3>
                <p class="guideline-content">{{ final_guideline | safe }}</p>
            </div>
        </div>
        {% endif %}

    </div>


    <!-- Analysis Results Section -->

</div>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" crossorigin="anonymous"></script>
<!-- Bootstrap 5 JS & Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF8ZRW3E6E4k/t8Hh7tY0fRS6P8qHcV9I6mDGM1If7HxhRDI3c" crossorigin="anonymous"></script>


<!-- Chart.js for Graph -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

{#    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>#}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>


<script>

    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form");

        form.addEventListener("submit", function () {
            // ‚úÖ Show loading screen when form is submitted
            document.getElementById('loading-spinner').style.display = 'flex';
        });

        // ‚úÖ Ensure the loading screen is hidden on page load
        window.onload = function () {
            document.getElementById('loading-spinner').style.display = 'none';
        };
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Monaco Editor Initialization
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

        require(["vs/editor/editor.main"], function () {
            window.editor = monaco.editor.create(document.getElementById("monaco-container"), {
                value: `{{ code|escapejs }}`,  // Load initial code if available
                language: "javascript",
                theme: "vs-dark",
                automaticLayout: true,
                minimap: { enabled: false },
            });
        });


    });
    // Handle file upload and display content in Monaco Editor
    document.getElementById('fileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                if (window.editor) {
                    window.editor.setValue(e.target.result);
                }
            };
            reader.readAsText(file);
        }
    });

    // Ensure the form submits Monaco Editor content
    document.querySelector("form").addEventListener("submit", function () {
        let code = window.editor.getValue();
        let textarea = document.getElementById("codeEditor");
        textarea.value = code;
    });

    //file upload
    document.addEventListener("DOMContentLoaded", function () {
        const fileInput = document.getElementById("fileInput");
        const fileNameDisplay = document.getElementById("fileNameDisplay");
        const uploadContainer = document.querySelector(".upload-container");

        // ‚úÖ Prevent the default browser behavior when dragging files over the drop zone
        uploadContainer.addEventListener("dragover", function (event) {
            event.preventDefault();
            event.stopPropagation();
            uploadContainer.style.background = "#e0f2ff"; // Highlight effect
        });

        uploadContainer.addEventListener("dragleave", function (event) {
            event.preventDefault();
            event.stopPropagation();
            uploadContainer.style.background = "#f8f9fa"; // Reset background
        });

        uploadContainer.addEventListener("drop", function (event) {
            event.preventDefault();
            event.stopPropagation();
            uploadContainer.style.background = "#f8f9fa"; // Reset background

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files; // Assign dropped files to input
                let fileList = Array.from(files).map(file => file.name).join(", ");
                fileNameDisplay.textContent = `Selected Files: ${fileList}`;

                // ‚úÖ Read file content and display it in Monaco Editor
                const reader = new FileReader();
                reader.onload = function (e) {
                    if (window.editor) {
                        window.editor.setValue(e.target.result);
                    }
                };
                reader.readAsText(files[0]); // Read only the first file's content
            }
        });

        // ‚úÖ Handle file selection from input
        fileInput.addEventListener("change", function () {
            if (this.files.length > 0) {
                let fileList = Array.from(this.files).map(file => file.name).join(", ");
                fileNameDisplay.textContent = `Selected Files: ${fileList}`;
            } else {
                fileNameDisplay.textContent = "";
            }
        });
    });



    ///github modal
    document.addEventListener("DOMContentLoaded", function () {
        const githubBtn = document.getElementById("githubBtn");
        const githubModal = document.getElementById("githubModal");
        const analyzeGithubBtn = document.getElementById("analyzeGithubBtn");
        const closeGithubBtn = document.getElementById("closeGithubBtn");
        const githubRepoUrl = document.getElementById("githubRepoUrl");
        const fileSelector = document.getElementById("fileSelector"); // Dropdown for file selection
        let fetchedFiles = []; // Store fetched files

        // Open modal
        githubBtn.addEventListener("click", function (event) {
            event.preventDefault();
            githubModal.style.display = "block";
        });

        // Close modal
        closeGithubBtn.addEventListener("click", function (event) {
            event.preventDefault();
            githubModal.style.display = "none";
        });

        // Handle GitHub analysis
        analyzeGithubBtn.addEventListener("click", function (event) {
            event.preventDefault();
            const repoUrl = githubRepoUrl.value.trim();

            if (!repoUrl) {
                alert("Please enter a GitHub repository URL.");
                return;
            }

            fetch("{% url 'analyze_code' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}" // CSRF token for security
                },
                body: JSON.stringify({ github_url: repoUrl })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert("Error fetching GitHub files: " + data.error);
                    } else {
                        fetchedFiles = data.files; // Store files for reference
                        fileSelector.innerHTML = ""; // Clear previous options

                        // ‚úÖ Add "All" option to dropdown
                        let allOption = document.createElement("option");
                        allOption.value = "all";
                        allOption.textContent = "All Files";
                        fileSelector.appendChild(allOption);

                        // ‚úÖ Add each file to dropdown
                        data.files.forEach((file, index) => {
                            let option = document.createElement("option");
                            option.value = index;
                            option.textContent = file.name;
                            fileSelector.appendChild(option);
                        });

                        if (fetchedFiles.length > 0) {
                            updateEditorWithFile(0); // Load the first file
                        }
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Failed to fetch GitHub files.");
                });

            githubModal.style.display = "none";
        });

        // Function to update Monaco Editor with selected file or all files
        function updateEditorWithFile(index) {
            if (index === "all") {
                let combinedCode = fetchedFiles.map(file => `# File: ${file.name}\n${file.code}`).join("\n\n");
                if (window.editor) {
                    window.editor.setValue(combinedCode);
                }
            } else {
                const selectedFile = fetchedFiles[index];
                if (selectedFile) {
                    if (window.editor) {
                        window.editor.setValue(selectedFile.code);
                    }
                }
            }
        }

        // Change Monaco Editor content when a new file is selected
        fileSelector.addEventListener("change", function () {
            updateEditorWithFile(this.value === "all" ? "all" : parseInt(this.value));
        });
    });

    
    //complexity chart
    document.addEventListener("DOMContentLoaded", function () {
        // Ensure summary data exists before rendering the chart
        const complexityMetrics = {
            "Lines of Code": {{ summary.complexity_metrics.lines_of_code|default:0 }},
            "Effective LOC": {{ summary.complexity_metrics.effective_lines_of_code|default:0 }},
            "Functions": {{ summary.complexity_metrics.num_functions|default:0 }},
            "Avg. Function Length": {{ summary.complexity_metrics.avg_function_length|default:0 }},
            "Duplicate Code (%)": {{ summary.complexity_metrics.duplicate_code_percentage|default:0 }},
            "Comment Density": {{ summary.complexity_metrics.comment_density|default:0 }},
            "Readability Score": {{ summary.complexity_metrics.readability_score|default:0 }},
            "Complexity Score": {{ summary.complexity_metrics.complexity_score|default:0 }}
        };

        // Ensure at least one non-zero value before rendering the chart
        if (Object.values(complexityMetrics).some(value => value > 0)) {
            const ctx = document.getElementById("complexityChart").getContext("2d");

            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: Object.keys(complexityMetrics),
                    datasets: [{
                        label: "Code Complexity Metrics",
                        data: Object.values(complexityMetrics),
                        backgroundColor: [
                            "#FF5733", "#33FFBD", "#337AFF", "#FF33E3",
                            "#FFCE33", "#33FF57", "#A833FF", "#FF8333"
                        ],
                        borderColor: "#FFFFFF",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: "#FFFFFF" }
                        },
                        x: {
                            ticks: { color: "#FFFFFF" }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false  // Hide the legend
                        }
                    }
                }
            });
        } else {
            console.warn("No valid complexity metrics found.");
        }
    });
    


                    //toast messages
                    document.addEventListener("DOMContentLoaded", function () {
                        // Function to show Bootstrap toast messages
                        function showToast(message, type = "primary") {
                            const toastElement = document.getElementById("generalToast");
                            const toastMessage = document.getElementById("toastMessage");

                            // Update message and class based on type
                            toastMessage.innerHTML = message;
                            toastElement.className = `toast align-items-center text-white bg-${type} border-0`;

                            // Show toast
                            const toast = new bootstrap.Toast(toastElement);
                            toast.show();
                        }

                        // üéØ 1Ô∏è‚É£ Show Toast When Uploading a File
                        document.getElementById('fileInput').addEventListener('change', function () {
                            if (this.files.length > 0) {
                                showToast("üìÇ File uploaded successfully!", "success");
                            }
                        });

                        // üéØ 2Ô∏è‚É£ Show Toast When Importing from GitHub
                        document.getElementById("analyzeGithubBtn").addEventListener("click", function () {
                            const repoUrl = document.getElementById("githubRepoUrl").value.trim();
                            if (repoUrl) {
                                showToast("üîÑ Fetching repository data from GitHub...", "info");
                            } else {
                                showToast("‚ö†Ô∏è Please enter a valid GitHub repository URL!", "danger");
                            }
                        });

                        // üéØ 3Ô∏è‚É£ Show Toast When Analysis Begins
                        document.querySelector("form").addEventListener("submit", function () {
                            showToast("‚ö° Code analysis started. Please wait...", "warning");
                        });

                        // üéØ 4Ô∏è‚É£ Show Toast When Analysis Results Are Available
                        const analysisResults = document.getElementById("analysis-results");
                        if (analysisResults && analysisResults.innerHTML.trim().length > 0) {
                            showToast("‚úÖ Code analysis completed!", "success");
                        }
                    });




                    document.addEventListener("DOMContentLoaded", function () {

                        Chart.defaults.color = "#ffffff"; // ‚úÖ Make all text white
                        Chart.defaults.font.size = 12; // ‚úÖ Adjust font size for better visibility
                        // Toggle severity details
                        document.querySelectorAll(".severity-toggle").forEach(item => {
                            item.addEventListener("click", function () {
                                const severity = this.getAttribute("data-severity").toLowerCase();
                                const details = document.getElementById(severity + "-details");

                                if (details.style.display === "none") {
                                    details.style.display = "block";
                                } else {
                                    details.style.display = "none";
                                }
                            });
                        });


                        const severityChart = new Chart(document.getElementById('severityChart'), {
                            type: 'pie',
                            data: {
                                labels: Object.keys({{ summary.severity|safe }}),
                        datasets: [{
                            label: 'Severity Levels',
                            data: Object.values({{ summary.severity|safe }}),
                        backgroundColor: ['#FF6384', '#FFCE56', '#4BC0C0'],
                            borderColor: ['#FF6384', '#FFCE56', '#4BC0C0'],
                            borderWidth: 1
                    }]
                    },
                    });
                    });

                    document.addEventListener("DOMContentLoaded", function () {
                        document.querySelectorAll(".category-toggle").forEach(item => {
                            item.addEventListener("click", function () {
                                const category = this.getAttribute("data-category");
                                const details = document.getElementById(category.replace(/\s+/g, '-').toLowerCase() + "-details");

                                if (details) {
                                    details.style.display = details.style.display === "none" ? "block" : "none";
                                }
                            });
                        });

                        // Define more colors for categories
                        const colorPalette = [
                            'rgba(75, 192, 192, 1)',   // Teal
                            'rgba(153, 102, 255, 1)',  // Purple
                            'rgba(255, 159, 64, 1)',   // Orange
                            'rgba(255, 99, 132, 1)',   // Red
                            'rgba(54, 162, 235, 1)',   // Blue
                            'rgba(255, 205, 86, 1)',   // Yellow
                            'rgba(46, 204, 113, 1)',   // Green
                            'rgba(231, 76, 60, 1)',    // Dark Red
                            'rgba(241, 196, 15, 1)',   // Bright Yellow
                            'rgba(155, 89, 182, 1)',   // Deep Purple
                            'rgba(52, 152, 219, 1)',   // Sky Blue
                            'rgba(39, 174, 96, 1)',    // Leaf Green
                            'rgba(243, 156, 18, 1)'    // Orange-Yellow
                        ];

                        const borderColorPalette = colorPalette.map(color => color.replace("1", "1")); // Darker border colors

                        // Generate category chart
                        const categoryLabels = Object.keys({{ summary.categories|safe }});
                        const categoryDataValues = Object.values({{ summary.categories|safe }});

                        const categoryChart = new Chart(document.getElementById('categoryChart'), {
                            type: 'pie',
                            data: {
                                labels: categoryLabels,
                                datasets: [{
                                    label: 'Categories',
                                    data: categoryDataValues,
                                    backgroundColor: categoryLabels.map((_, index) => colorPalette[index % colorPalette.length]), // Cycle colors
                                    borderColor: categoryLabels.map((_, index) => borderColorPalette[index % borderColorPalette.length]), // Cycle border colors
                                    borderWidth: 1
                                }]
                            }
                        });
                    });



                    // Severity Level Distribution Chart
                    const severityData = {
                        labels: Object.keys({{ summary.severity|safe }}),
                    datasets: [{
                        label: 'Severity Levels',
                        data: Object.values({{ summary.severity|safe }}),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)', // Critical - Red
                        'rgba(255, 206, 86, 0.2)', // Medium - Yellow
                        'rgba(75, 192, 192, 0.2)', // Low - Green
                    ],
                        borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                ],
                    borderWidth: 1
                }]
                };


                    // Handle file upload and display content in the editor
                    document.getElementById('fileInput').addEventListener('change', function (event) {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                codeMirrorEditor.setValue(e.target.result);
                            };
                            reader.readAsText(file);
                        }
                    });

</script>



<style>
    /* General Background and Text Adjustments for Dark Mode */
    .dark-mode {
        background-color: #121212; /* Deep dark background */
        color: #ffffff; /* Ensure text remains white */
    }

    /* Ensure Containers Stand Out in Dark Mode */
    .summary-panel,
    .chart-container,
    .severity-container,
    .category-container,
    .recommendation-container {
        background-color: #1a1f3b !important; /* Deep navy blue */
        color: #ffffff !important;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0px 0px 8px rgba(0, 123, 255, 0.2); /* Subtle glow effect */
    }

    .recommendation-container {
        background-color: #232a45 !important; /* Slightly lighter navy */
        color: #ffffff !important;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0px 0px 8px rgba(0, 123, 255, 0.2); /* Subtle glow effect */
        max-height: 450px; /* Fixed height */
        overflow-y: auto; /* Enable scrolling */
    }
    /* Fix Clickable Elements */
    .category-toggle,
    .severity-toggle,
    .upload-container,
    .upload-box,
    .btn-github,
    .github-modal-content .btn,
    .list-group-item,
    .nav-link {
        cursor: pointer !important; /* ‚úÖ Forces the hand cursor */
    }
    /* Improve Contrast for Code Blocks */
    .code-block {
        background-color: #232a45 !important; /* Slightly lighter navy */
        border: 1px solid #007bff !important; /* Bright blue border */
        color: #ffffff !important;
        padding: 12px;
        border-radius: 6px;
        box-shadow: 0px 0px 5px rgba(0, 123, 255, 0.2);
    }

    /* Suggestions Should Stand Out */
    .suggestion-block {
        background-color: #1b3a31 !important; /* Dark teal */
        border: 1px solid #28a745 !important; /* Green border */
        color: #ffffff !important;
        padding: 12px;
        border-radius: 6px;
        box-shadow: 0px 0px 5px rgba(40, 167, 69, 0.3); /* Subtle green glow */
    }
    .suggestion-block pre {
        white-space: pre-wrap; /* Ensures wrapping */
        word-wrap: break-word; /* Break long words if necessary */
        overflow-wrap: break-word; /* Ensures content breaks properly */
        max-width: 100%; /* Prevents it from exceeding the parent container */
        background-color: transparent; /* Keep same background as parent */
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        overflow-x: auto; /* Allows horizontal scrolling if needed */
    }

    /* Ensure Toggle Elements are Readable */
    .category-toggle,
    .severity-container {
        background-color: #212d48 !important; /* Deep blue */
        color: white !important;
        border: 1px solid rgba(255, 255, 255, 0.3); /* Light border */
        border-radius: 8px;
        padding: 15px;
    }

    /* ‚úÖ Improve Expandable Category Details */
    .category-details,
    .severity-details {
        background-color: #1f2638 !important;
        border: 1px solid #007bff !important;
        padding: 10px;
        border-radius: 6px;
        max-height: 250px; /* Fixed height */
        overflow-y: auto; /* Enable scrolling */
        transition: all 0.3s ease-in-out;
    }

    /* ‚ú® Improve Category Toggle */
    .category-toggle,
    .severity-toggle {
        color: #f1c40f !important; /* Golden yellow */
        font-weight: bold;
        cursor: pointer !important;
    }

    /* üìå Improve List Items */
    .list-group-item {
        background-color: #2a3550 !important; /* Dark blue */
        color: #ffffff !important;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .category-toggle:hover,
    .severity-toggle:hover {
        color: #ffcc00 !important; /* Bright yellow on hover */
    }

    .list-group-item:hover {
        background-color: #36456b !important; /* Lighter navy on hover */
    }

    /* Make Uploaded File Name Visible */
    #fileNameDisplay {
        color: #ffffff !important;
    }

    /* Make Upload Box More Visible */
    .upload-container {
        border: 2px dashed #007bff;
        background: rgba(0, 123, 255, 0.1) !important; /* Subtle blue tint */
    }

    .upload-box {
        color: #007bff !important; /* Text should match your theme */
    }

    /* Improve Button Visibility */
    .btn-github {
        background-color: #007bff !important;
        color: white !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    .btn-github:hover {
        background-color: white !important;
        color: #007bff !important;
    }

    /* Adjust the Chart Labels */
    .chart-container canvas {
        color: white !important;
    }

    /* Ensure Form Labels are Readable */
    .form-label {
        color: white !important;
    }


    /* Custom GitHub Button Styling */
    .btn-github {
        background: #007bff !important; /* ‚úÖ Bright Blue */
        color: white !important;
        border-radius: 8px;
        font-weight: 500;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        border: none;
        text-shadow: 0px 0px 2px rgba(0, 0, 0, 0.2); /* ‚úÖ Subtle shadow for better visibility */
    }

    /* Ensure the icon is also visible */
    .btn-github i {
        color: white !important; /* ‚úÖ Make sure the GitHub icon is visible */
        margin-right: 8px;
        font-size: 18px;
    }

    /* Hover Effect */
    .btn-github:hover {
        background: white !important; /* ‚úÖ Invert colors for better contrast */
        color: #007bff !important;
        transform: translateY(-2px);
    }

    /* Active (Click) Effect */
    .btn-github:active {
        transform: scale(0.98);
    }

    /* Extra Fix: Ensure Dark Mode Doesn't Override Styles */
    .dark-mode .btn-github {
        background: #007bff !important;
        color: white !important;
        border: 2px solid #007bff;
    }



    /* GitHub Import Modal */
    /* GitHub Import Modal */
    .github-modal {
        display: none; /* Initially hidden */
        position: fixed;
        z-index: 1050; /* Higher than normal elements */
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 420px;
        background: #2c3e50; /* Modern dark blue */
        padding: 25px;
        border-radius: 12px; /* Softer edges */
        box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.3);
        text-align: center;
        color: white; /* White text for contrast */
    }

    /* Modal Background Overlay */
    .github-modal::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6); /* Darker overlay for focus */
        z-index: -1;
    }

    /* Modal Content */
    .github-modal-content {
        padding: 20px;
    }

    /* Modal Header */
    .github-modal h4 {
        font-size: 22px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #f1c40f; /* Yellow-Gold heading */
    }

    /* Input Field */
    .github-modal input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: none;
        margin-top: 10px;
        background: #ecf0f1; /* Light gray background */
        color: #333;
        font-size: 16px;
    }

    /* Buttons inside the modal */
    .github-modal-content .btn {
        margin: 5px;
        padding: 10px 16px;
        font-size: 14px;
        border-radius: 8px;
        transition: all 0.2s ease-in-out;
    }

    /* Analyze Button */
    #analyzeGithubBtn {
        background: #27ae60; /* Green */
        color: white;
        border: none;
    }

    #analyzeGithubBtn:hover {
        background: #219150;
    }

    /* Close Button */
    #closeGithubBtn {
        background: #e74c3c; /* Red */
        color: white;
        border: none;
    }

    #closeGithubBtn:hover {
        background: #c0392b;
    }
    /* üî• Developer Guideline Section */

    .guideline-panel {
        background: linear-gradient(135deg, #1e3c72, #2a5298); /* Sleek dark-blue gradient */
        color: white; /* White text for better contrast */
        border-radius: 12px;
        box-shadow: 0px 12px 30px rgba(0, 0, 0, 0.4); /* More prominent shadow */
        padding: 30px;
        max-width: 850px;
        margin: auto;
        transition: transform 0.3s ease-in-out;
        border-left: 5px solid #f1c40f; /* Gold accent on the left */
    }

    /* Hover Effect */
    .guideline-panel:hover {
        transform: translateY(-5px); /* Slight elevation on hover */
    }

    /* Title Styling */
    .guideline-title {
        font-size: 26px;
        font-weight: bold;
        color: #f1c40f; /* Gold for highlighting */
        text-shadow: 1px 1px 4px rgba(255, 204, 0, 0.5); /* Glowing effect */
    }

    /* Content Styling */
    .guideline-content {
        font-size: 18px;
        line-height: 1.6;
        text-align: center;
        padding: 15px;
        font-weight: 500;
    }

    /* Smooth Fade-in Effect */
    .guideline-panel {
        opacity: 0;
        animation: fadeIn 0.8s ease-in-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(15px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }


    .upload-container {
        background: rgba(255, 255, 255, 0.05); /* Light transparency */
        border: 2px dashed #0D92F4;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease-in-out;
        cursor: pointer;
        color: #007bff !important; /* üîµ Ensure text is visible */
    }

    .upload-box {
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        color: #007bff !important; /* üîµ Ensure text remains visible */
    }

    .upload-container:hover {
        background: rgba(255, 255, 255, 0.1); /* Slightly brighter on hover */
        border-color: #0056b3;
    }

    .upload-box i {
        color: #007bff !important; /* Ensure icon is visible */
    }

    .custom-dropdown {
        font-weight: bold;
        border-radius: 8px;
        padding: 10px;
        background: #f8f9fa;
        transition: all 0.3s ease-in-out;
    }

    /* Change dropdown hover effect */
    .custom-dropdown:hover {
        background: #e9ecef;
    }

    /* Style Monaco Editor Container */
    #monaco-container {
        height: 400px;
        border: 2px solid #007bff;
        border-radius: 8px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* loader */
    .dots-loader {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .dots-loader span {
        width: 15px;
        height: 15px;
        margin: 5px;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    /* Assign different colors to each dot */
    .dots-loader .red {
        background-color: #ff4d4d; /* Red */
        animation-delay: -0.32s;
    }

    .dots-loader .yellow {
        background-color: #ffd700; /* Yellow */
        animation-delay: -0.16s;
    }

    .dots-loader .green {
        background-color: #4caf50; /* Green */
        animation-delay: 0s;
    }

    .dots-loader .blue {
        background-color: #1e90ff; /* Blue */
        animation-delay: 0.16s;
    }

    @keyframes bounce {
        0%, 80%, 100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1);
        }
    }
</style>

{% endblock %}
