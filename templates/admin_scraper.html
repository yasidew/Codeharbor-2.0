
{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h4 class="card-title">GitHub Challenges</h4>
        {% block title %}
            {% if game %}
                GitHub Challenges - {{ game.id }} - {{ game.name }}
            {% else %}
                GitHub Challenges Admin
            {% endif %}
        {% endblock %}
        <p class="card-category">Fetch and manage accessibility challenges from GitHub</p>
    </div>
    <div class="card-body">
        <button id="fetchChallengesBtn" class="btn btn-primary">
            <i class="bi bi-download"></i> Fetch New Challenges
        </button>

    <button id="claimBadges" class="btn btn-warning mt-3">
    <i class="bi bi-trophy"></i> Claim Badges
</button>

    <button id="seeBadges" class="btn btn-info mt-3">
    <i class="bi bi-eye"></i> See Badges
</button>

        <div id="loading" class="mt-3" style="display: none;">
            <span class="spinner-border spinner-border-sm"></span> Fetching...
        </div>

    <!-- Badges Display Container -->
<div id="badgesContainer" class="mt-3">
    <h5 class="text-warning">üèÖ Earned Badges</h5>
    <div id="badgesList" class="d-flex flex-wrap"></div>
</div>

        <div class="table-responsive mt-4">
            <table class="table">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Title</th>
                        <th>Difficulty</th>
                        <th>Repo URL</th>
                    </tr>
                </thead>
                <tbody>
                    {% for challenge in challenges %}
                        <tr>
                            <td>
                                <input type="radio" name="selectedChallenge" value="{{ challenge.id }}"
                                    data-title="{{ challenge.title }}"
                                    data-repo="{{ challenge.repo_url }}"
                                    data-file="{{ challenge.file_url }}">
                            </td>
                            <td><a href="{{ challenge.file_url }}" target="_blank">{{ challenge.id }} - {{ challenge.title }}</a></td>
                            <td>{{ challenge.get_difficulty_display }}</td>
                            <td><a href="{{ challenge.repo_url }}" target="_blank">Repo</a></td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="4">No challenges available.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Submit Button -->
        <button id="submitBtn" class="btn btn-success mt-3">Go to Checker</button>
    </div>
</div>

<script>
document.getElementById("fetchChallengesBtn").addEventListener("click", function () {
        let fetchBtn = document.getElementById("fetchChallengesBtn");
        let loadingIndicator = document.getElementById("loading");

        // Disable button and show loading
        fetchBtn.disabled = true;
        loadingIndicator.style.display = "block";

        fetch("http://127.0.0.1:8000/games/fetch-github-code/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")  // Include CSRF token
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log("‚úÖ Response:", data);

            if (data.message) {
                alert("‚úÖ " + data.message);
                location.reload();  // Reload page to update challenge list
            } else {
                alert("‚ùå Error fetching challenges.");
            }
        })
        .catch(error => {
            console.error("‚ùå Fetch Error:", error);
            alert("‚ùå Failed to fetch challenges.");
        })
        .finally(() => {
            // Enable button and hide loading indicator
            fetchBtn.disabled = false;
            loadingIndicator.style.display = "none";
        });
    });

    // Function to get CSRF Token for Django requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            document.cookie.split(";").forEach(cookie => {
                let trimmedCookie = cookie.trim();
                if (trimmedCookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(trimmedCookie.substring(name.length + 1));
                }
            });
        }
        return cookieValue;
    }
    document.getElementById("submitBtn").addEventListener("click", function () {
        let selectedChallenge = document.querySelector('input[name="selectedChallenge"]:checked');

        if (!selectedChallenge) {
            alert("Please select a challenge before proceeding!");
            return;
        }

        // Extract challenge details
        let challengeId = selectedChallenge.value;
        let challengeTitle = selectedChallenge.dataset.title;

        // Extract game details from the template
        let gameId = "{{ game.id }}";
        let gameName = "{{ game.name }}";

        let data = {
            game_name: gameName,
            challenge_id: challengeId
        };

        // Log details to console for testing
        console.log("Redirecting with Data:", data);

        // Redirect to /checker/ with query parameters
        let queryString = new URLSearchParams(data).toString();
        window.location.href = `http://127.0.0.1:8000/checker/?${queryString}`;
    });


    document.getElementById("claimBadges").addEventListener("click", async function () {
    const accessToken = localStorage.getItem('accessToken');
    if (!accessToken) {
        alert("You are not logged in! Redirecting to login...");
        window.location.href = '/login';
        return;
    }

    let userId = sessionStorage.getItem("user_id") || localStorage.getItem("user_id");
    if (!userId) {
        alert("‚ùå User ID not found! Please submit your score first.");
        return;
    }

    try {
        // ‚úÖ Fetch Total Critical Score BEFORE assigning badge
        let totalCriticalScoreResponse = await fetch(`http://127.0.0.1:8000/games/total-critical-score/${userId}/`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "X-CSRFToken": getCookie("csrftoken")
            }
        });

        let totalCriticalScoreData = await totalCriticalScoreResponse.json();
        let totalCriticalScore = totalCriticalScoreData.total_critical_score || 0;
        console.log("üîπ Total Critical Score:", totalCriticalScore);

        // ‚úÖ Assign Critical Score Badge
        let criticalBadgeResponse = await fetch("http://127.0.0.1:8000/games/store-badge/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${accessToken}`,
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({ user_id: userId })
        });

        let criticalBadgeResult = await criticalBadgeResponse.json();
        console.log("üîπ Assigned Critical Badge:", criticalBadgeResult.assigned_badge);

        // ‚úÖ Assign Challenge Completion Badge
        let challengeBadgeResponse = await fetch("http://127.0.0.1:8000/games/store-challenge-badge/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${accessToken}`,
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({ user_id: userId })
        });

        let challengeBadgeResult = await challengeBadgeResponse.json();
        console.log("üîπ Assigned Challenge Badge:", challengeBadgeResult.assigned_badge);

        // ‚úÖ Alert the user about assigned badges
        let alertMessage = `üéâ Badges Assigned:\n`;
        if (criticalBadgeResponse.ok) {
            alertMessage += `üèÖ Critical Score Badge: ${criticalBadgeResult.assigned_badge}\n`;
        }
        if (challengeBadgeResponse.ok) {
            alertMessage += `üéñÔ∏è Challenge Badge: ${challengeBadgeResult.assigned_badge}`;
        }
        alert(alertMessage);
    } catch (error) {
        console.error("Error claiming badges:", error);
        alert("‚ùå Failed to claim badges.");
    }
});

    document.getElementById("seeBadges").addEventListener("click", async function () {
    const accessToken = localStorage.getItem('accessToken');
    if (!accessToken) {
        alert("You are not logged in! Redirecting to login...");
        window.location.href = '/login';
        return;
    }

    let userId = sessionStorage.getItem("user_id") || localStorage.getItem("user_id");
    if (!userId) {
        alert("‚ùå User ID not found! Please log in.");
        return;
    }

    try {
        let response = await fetch(`http://127.0.0.1:8000/games/user-badges/${userId}/`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "X-CSRFToken": getCookie("csrftoken")
            }
        });

        let data = await response.json();
        console.log("Fetched Badges Data:", data);  // Debugging: Ensure data is received

        let badgesContainer = document.getElementById("badgesContainer");
        let badgesList = document.getElementById("badgesList");

        // Clear previous content
        badgesContainer.innerHTML = "";

        if (!data.badges || data.badges.length === 0) {
            badgesContainer.innerHTML = "<p class='text-muted'>No badges earned yet.</p>";
            return;
        }

        // Ensure badges list container exists
        if (!badgesList) {
            badgesList = document.createElement("div");
            badgesList.id = "badgesList";
            badgesContainer.appendChild(badgesList);
        }

        // Display Badges in UI
        data.badges.forEach(badge => {
            let badgeCard = document.createElement("div");
            badgeCard.classList.add("badge-card", "p-3", "m-2", "text-center");
            badgeCard.innerHTML = `
                <div class="badge-icon">üèÜ</div>
                <strong class="badge-name">${badge.name}</strong>
                <p class="badge-desc text-muted">${badge.description}</p>
            `;
            badgesList.appendChild(badgeCard);
        });

    } catch (error) {
        console.error("‚ùå Error fetching badges:", error);
        alert("‚ùå Failed to fetch badges.");
    }
});


// ‚úÖ Function to Get CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        document.cookie.split(";").forEach(cookie => {
            let trimmedCookie = cookie.trim();
            if (trimmedCookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(trimmedCookie.substring(name.length + 1));
            }
        });
    }
    return cookieValue;
}


</script>

    <style>
    #claimBadges {
    background-color: #ffcc00; /* Gold color */
    color: #333; /* Dark text */
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid #ffbb00;
    transition: all 0.3s ease-in-out;
}

#claimBadges:hover {
    background-color: #ffbb00;
    color: white;
    transform: scale(1.05);
}

#seeBadges {
    background-color: #17a2b8; /* Info color */
    color: white;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 8px;
    transition: all 0.3s ease-in-out;
}

#seeBadges:hover {
    background-color: #138496;
    transform: scale(1.05);
}

#badgesContainer {
    padding: 15px;
    border-radius: 8px;
    background-color: #f8f9fa;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
}

    </style>

{% endblock %}