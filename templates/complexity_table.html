{% extends 'base.html' %}
{% load static %}

{% block title %}Code Complexity Calculator - Java{% endblock %}

{% block content %}

    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: Arial, sans-serif;
        }

        .container {
            width: 80%;
            margin: auto;
            text-align: center;
        }

        h1, h2, h3, h4 {
            color: #58a6ff;
        }

        table {
            width: 100%; /* Adjust as needed */
            margin: 20px auto;
            border-collapse: collapse;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
            table-layout: fixed;
        }

        th, td {
            padding: 12px;
            border: 1px solid #30363d;
            text-align: left; /* Align text for readability */
            white-space: normal; /* Allow text wrapping */
            word-wrap: break-word; /* Ensure long words wrap */
            overflow-wrap: break-word;
        }

        th {
            background-color: #161b22;
            color: #c9d1d9;
        }

        tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.02);
        }

        th:nth-child(1), td:nth-child(1) { /* Line column */
            width: 20%; /* Give code more space */
            text-align: left; /* Align text for readability */
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }

        th:nth-child(1), td:nth-child(1) { /* Line column */
            width: 5%; /* Give code more space */
            text-align: left; /* Align text for readability */
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }


        /* Increase the width of the 'Line' and 'Tokens' columns */
        th:nth-child(2), td:nth-child(2) { /* Line column */
            width: 40%; /* Give code more space */
            text-align: left; /* Align text for readability */
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }

        th:nth-child(4), td:nth-child(4) { /* Tokens column */
            width: 20%;
            text-align: left; /* Align text for readability */
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }


        /* Ensure the remaining columns fit well */
        th, td {
            white-space: nowrap;
        }

        button {
            background-color: #238636;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            border-radius: 5px;
        }

        button:hover {
            background-color: #2ea043;
        }

        .metrics, .line-complexity, .method-complexity, .recommendations {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 50%;
            height: auto;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-radius: 10px;
        }

        .modal-content {
            background-color: #161b22;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .modal img {
            max-width: 100%;
            height: auto;
        }

        /* Unique styling for Method Complexity Table */
        .method-complexity-table {
            width: 95%;
            margin: 20px auto;
            border-collapse: separate; /* Different border design */
            border-spacing: 0 10px; /* Space between rows */
            background-color: rgba(40, 44, 52, 0.8); /* Darker background */
            border-radius: 10px;
            overflow: hidden;
            table-layout: auto;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        /* Header Styling */
        .method-complexity-table th {
            background-color: #161b22;
            color: #c9d1d9;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #30363d;
        }

        /* Row Styling */
        .method-complexity-table tr {
            transition: all 0.3s ease-in-out;
        }

        /* Row Hover Effect */
        .method-complexity-table tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Cell Styling */
        .method-complexity-table td {
            padding: 12px;
            border: 1px solid #30363d;
            text-align: center;
            font-size: 14px;
        }

        /* Adjust Column Widths */
        .method-complexity-table th:nth-child(1), .method-complexity-table td:nth-child(1) { /* Method Name */
            width: 25%;
            text-align: left;
        }

        .method-complexity-table th:nth-child(2), .method-complexity-table td:nth-child(2) { /* S */
            width: 5%;
        }

        .method-complexity-table th:nth-child(3),
        .method-complexity-table td:nth-child(3),
        .method-complexity-table th:nth-child(4),
        .method-complexity-table td:nth-child(4),
        .method-complexity-table th:nth-child(5),
        .method-complexity-table td:nth-child(5),
        .method-complexity-table th:nth-child(6),
        .method-complexity-table td:nth-child(6),
        .method-complexity-table th:nth-child(7),
        .method-complexity-table td:nth-child(7),
        .method-complexity-table th:nth-child(8),
        .method-complexity-table td:nth-child(8),
        .method-complexity-table th:nth-child(9),
        .method-complexity-table td:nth-child(9),
        .method-complexity-table th:nth-child(10),
        .method-complexity-table td:nth-child(10) { /* All Weight Columns */
            width: 6%;
            text-align: center;
        }

        /* Category Column */
        .method-complexity-table th:nth-child(11), .method-complexity-table td:nth-child(11) {
            width: 10%;
            font-weight: bold;
        }

        /* Bar Chart Button Column */
        .method-complexity-table th:nth-child(12), .method-complexity-table td:nth-child(12) {
            width: 10%;
        }

        .recommendations-table {
            width: 100%; /* Expand table width */
            max-width: 95%;
            margin: 20px auto;
            border-collapse: separate;
            border-spacing: 0 10px;
            background-color: rgba(30, 40, 50, 0.9);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Header Styling */
        .recommendations-table th {
            background-color: #161b22;
            color: #ffcc00;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* Table Cells */
        .recommendations-table td {
            padding: 12px;
            border: 1px solid #30363d;
            text-align: left;
            font-size: 14px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal; /* Allow text to wrap */
        }

        /* Adjust Column Widths */
        .recommendations-table th:nth-child(1), .recommendations-table td:nth-child(1) { /* Line Number */
            width: 10%;
            text-align: center;
        }

        .recommendations-table th:nth-child(2), .recommendations-table td:nth-child(2) { /* Line Content */
            width: 30%;
        }

        .recommendations-table th:nth-child(3), .recommendations-table td:nth-child(3) { /* Recommendation */
            width: 60%; /* More space for recommendations */
        }

        /* Hover Effect for Readability */
        .recommendations-table tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Ensure List Items in Recommendations Wrap Properly */
        .recommendations-table ul {
            padding-left: 15px;
        }

        .recommendations-table li {
            list-style: none;
            font-size: 14px;
            padding-bottom: 5px;
        }

        .cbo-analysis-table {
            width: 100%; /* Expand table width */
            max-width: 95%; /* Prevent excessive stretching */
            margin: 20px auto;
            border-collapse: separate;
            border-spacing: 0 10px;
            background-color: rgba(30, 40, 50, 0.9);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        /* Header Styling */
        .cbo-analysis-table th {
            background-color: #161b22;
            color: #ffcc00;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* Cell Styling */
        .cbo-analysis-table td {
            padding: 12px;
            border: 1px solid #30363d;
            text-align: left;
            font-size: 14px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal; /* Ensure text wraps */
        }

        /* Adjust Column Widths */
        .cbo-analysis-table th:nth-child(1), .cbo-analysis-table td:nth-child(1) { /* File Name */
            width: 15%;
            text-align: center;
        }

        .cbo-analysis-table th:nth-child(2), .cbo-analysis-table td:nth-child(2) { /* CBO Prediction */
            width: 20%;
            text-align: center;
            font-weight: bold;
        }

        /* Increase the width of the Recommendations column */
        .cbo-analysis-table th:nth-child(3), .cbo-analysis-table td:nth-child(3) { /* Recommendations */
            width: 65%; /* More space for recommendations */
            text-align: left;
            white-space: normal;
        }

        /* Ensure List Items Wrap Properly */
        .cbo-analysis-table ul {
            padding-left: 15px;
        }

        .cbo-analysis-table li {
            list-style: none;
            font-size: 14px;
            padding-bottom: 5px;
        }

        .complexity-legend {
            display: flex;
            justify-content: center; /* Center the legend */
            gap: 20px; /* Space between legend items */
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            width: fit-content;
            margin: 0 auto 20px auto; /* Center horizontally & add spacing */
            border-bottom: 2px solid #c9d1d9; /* Add bottom border to separate */
        }

        /* 🔹 Legend Items */
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 16px;
        }

        /* 🔹 Small Colored Boxes */
        .complexity-box {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 4px;
            margin-right: 10px;
        }

        /* 🔹 Color Coding */
        .high {
            background-color: red;
            border: 1px solid #721c24;
        }

        .medium {
            background-color: yellow;
            border: 1px solid #856404;
        }

        .low {
            background-color: green;
            border: 1px solid #155724;
        }

        /* 🔹 Adjust the Heading */
        h3 {
            text-align: center;
            margin-bottom: 15px;
        }

        .cbo-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
        }

        .low-cbo-circle {
            background: green;
            border: 2px solid #856404;
        }

        .high-cbo-circle {
            background: red;
            border: 2px solid #721c24;
        }

        /* Table Row Styling */
        .high-cbo {
            background-color: #f8d7da;
            color: #721c24;
        }

        .low-cbo {
            background-color: #d4edda;
            color: #155724;
        }

        .low-p {
            color: green;
        }

        .high-p {
            color: red;
        }

        .custom-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: green;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .show-toast {
            opacity: 1;
        }

        {#    model reccomendation #}

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            background-color: #0d1117;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
            color: #c9d1d9;
            padding: 20px;
            font-family: 'Fira Code', monospace;
        }

        .modal-content {
            background-color: #161b22;
            padding: 20px;
            border-radius: 8px;
        }

        h3, h4 {
            color: #58a6ff;
        }

        pre {
            background-color: #0d1117;
            color: #c9d1d9;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.5;
        }

        code {
            font-family: 'Fira Code', monospace;
            white-space: pre;
            display: block;
        }

    </style>

    <h1 class="container">Code Complexity Results for Java</h1>

    <div class="container mt-4">
        <h4 class="mt-5">New Weighted Code Complexity (WCC) Equation</h4>
        <h3>
            <pre><code>WCC<sub>i</sub> = S<sub>i</sub> * (W<sub>c</sub> + W<sub>n</sub> + W<sub>i</sub> + W<sub>tc</sub> + W<sub>cc</sub> + W<sub>th</sub> +( W<sub>cbo</sub>(high coupling) - W<sub>cbo</sub>(loose coupling)))</code></pre>
        </h3>
    </div>

    <div class="container mt-4">
        <h4 class="mt-5">Equation of Total WCC for the Class</h4>
        <h3>
            <pre><code>WCC<sub>total</sub> = Σ (WCC<sub>i</sub>) for i=1 to N</code></pre>
        </h3>
    </div>

    <button class="btn btn-info" onclick="window.location.href='/guidelines/'">View Guidelines</button>

    {% for file in complexities %}
        <div class="metrics container xx">
            <h2>Filename: {{ file.filename }}</h2>
            <h2>Class Complexity</h2>
            <table style="border: 1px solid white; color: white;">
                <thead>
                <tr>
                    <th style="width: 40%;">Class Name</th>
                    <th style="width: 30%;">Complexity Score</th>
                    <th style="width: 30%;">Pie Chart</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>{{ file.filename }}</td>
                    <td>{{ file.total_wcc }}</td>
                    <td>
                        <button class="btn" onclick="showPieChart('{{ file.filename }}', '{{ file.pie_chart_path }}')">
                            View Pie Chart
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="line-complexity">
            <h3>Line Complexity Details</h3>
            <table>
                <thead>
                <tr>
                    <th>Line No</th>
                    <th>Line</th>
                    <th>S</th>
                    <th>Tokens</th>
                    <th>W<sub>c</sub></th>
                    <th>W<sub>n</sub></th>
                    <th>W<sub>i</sub></th>
                    <th>W<sub>cc</sub></th>
                    <th>W<sub>tc</sub></th>
                    <th>W<sub>th</sub></th>
                    <th>W<sub>cbo</sub></th>
                    <th>S*W</th>
                </tr>
                </thead>
                <tbody>
                {% for line in file.complexity_data %}
                    <tr>
                        <td>{{ line.0 }}</td>
                        <td>{{ line.1 }}</td>
                        <td>{% if line.2 != 0 %}{{ line.2 }}{% endif %}</td>
                        <td>{% if line.2 != 0 %}{{ line.3 }}{% endif %}</td>
                        <td>{% if line.2 != 0 %}{{ line.4 }}{% endif %}</td>
                        <td>{% if line.2 != 0 %}{{ line.5 }}{% endif %}</td>
                        <td>{% if line.2 != 0 %}{{ line.6 }}{% endif %}</td>
                        <td>{% if line.2 != 0 %}{{ line.7 }}{% endif %}</td>
                        <td>{% if line.2 != 0 %}{{ line.8 }}{% endif %}</td>
                        <td>{% if line.2 != 0 %}{{ line.9 }}{% endif %}</td>
                        <td>{% if line.2 != 0 %}{{ line.10 }}{% endif %}</td>
                        <td>{% if line.2 != 0 %}{{ line.11 }}{% endif %}</td>
                        <td>{% if line.2 != 0 %}{{ line.12 }}{% endif %}</td>
                    </tr>
                {% endfor %}

                <tr>
                    <td colspan="10" style="text-align: right; font-weight: bold;">Total WCC:</td>
                    <td></td>
                    <td style="font-weight: bold;">{{ file.total_wcc }}</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="container mt-5">
            <h3 class="method-complexity">Method Complexity Details</h3>
            <div class="complexity-legend">
                <div class="legend-item">
                    <span class="complexity-box high"></span>
                    <strong style="color: #721c24;">High Complexity</strong>
                </div>
                <div class="legend-item">
                    <span class="complexity-box medium"></span>
                    <strong style="color: #856404;">Medium Complexity</strong>
                </div>
                <div class="legend-item">
                    <span class="complexity-box low"></span>
                    <strong style="color: #155724;">Low Complexity</strong>
                </div>
            </div>
            <table class="method-complexity-table">
                <thead>
                <tr>
                    <th>Method Name</th>
                    <th>S</th>
                    <th>W<sub>c</sub></th>
                    <th>W<sub>n</sub></th>
                    <th>W<sub>i</sub></th>
                    <th>W<sub>cc</sub></th>
                    <th>W<sub>tc</sub></th>
                    <th>W<sub>th</sub></th>
                    <th>W<sub>cbo</sub></th>
                    <th>Total Complexity</th>
                    <th>Category</th>
                    <th>Bar Chart</th>
                </tr>
                </thead>
                <tbody>
                {% for method in file.method_complexities %}
                    <tr style="
                            {% if method.category == 'High' %}background-color: #f8d7da; color: #721c24;{% endif %}
                            {% if method.category == 'Medium' %}background-color: #fff3cd; color: #856404;{% endif %}
                            {% if method.category == 'Low' %}background-color: #d4edda; color: #155724;{% endif %}
                            ">
                        <td>{{ method.method_name }}</td>
                        <td>{{ method.size }}</td>
                        <td>{{ method.control_structure_complexity }}</td>
                        <td>{{ method.nesting_level }}</td>
                        <td>{{ method.inheritance_level }}</td>
                        <td>{{ method.compound_condition_weight }}</td>
                        <td>{{ method.try_catch_weight }}</td>
                        <td>{{ method.thread_weight }}</td>
                        <td>{{ method.cbo_weights }}</td>
                        <td>{{ method.total_complexity }}</td>
                        <td>{{ method.category }}</td>
                        <td>
                            <button class="btn"
                                    onclick="showBarChart('{{ method.method_name }}', '{{ method.bar_chart }}')">
                                View Chart
                            </button>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="container mt-5">
            <h3>Complexity Reduction Recommendations</h3>
            <table class="recommendations-table">
                <thead>
                <tr>
                    <th>Line Number</th>
                    <th>Line Content</th>
                    <th>Recommendation</th>
                    <th>Refactoring Example</th>
                </tr>
                </thead>
                <tbody>
                {% if file.recommendations %}
                    {% for rec in file.recommendations %}
                        <tr class="recommendation-row">
                            <td>{{ rec.line_number }}</td>
                            <td>{{ rec.line_content }}</td>
                            <td class="recommendation-text">{{ rec.recommendation }}</td>
                            <td>
                                {% if rec.recommendation %}
                                    <button class="btn btn-info"
                                            onclick="showRefactorExample('{{ rec.recommendation }}')">
                                        View Example
                                    </button>
                                {% else %}
                                    No Example Available
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="3" style="text-align: center; color: #c9d1d9; font-style: italic;">
                            No recommendations available
                        </td>
                    </tr>
                {% endif %}
                </tbody>
            </table>
        </div>

        <div class="container mt-5">
            <h3>🔍 CBO Analysis</h3>
            <div class="complexity-legend">
                <div class="legend-item">
                    <span class="complexity-box low"></span>
                    <strong style="color: #155724;">Low CBO</strong>
                    <p class="low-p">(A class has few dependencies on other classes.)</p>
                </div>
                <div class="legend-item">
                    <span class="complexity-box high"></span>
                    <strong style="color: #721c24">High CBO</strong>
                    <p class="high-p">(A class has many dependencies on other classes.)</p>
                </div>
            </div>
            <table class="cbo-analysis-table">
                <thead>
                <tr>
                    <th>File Name</th>
                    <th>CBO Prediction</th>
                    <th>Recommendations</th>
                </tr>
                </thead>
                <tbody>
                {% for cbo in cbo_predictions %}
                    {% if cbo.filename == file.filename %}
                        <tr class="{% if cbo.prediction == 'High CBO (Issue)' %}high-cbo{% else %}low-cbo{% endif %}">
                            <td>{{ cbo.filename }}</td>
                            <td>
                                {% if cbo.prediction == 'High CBO (Issue)' %}
                                    <span class="cbo-indicator high-cbo-circle"></span> {{ cbo.prediction }}
                                {% else %}
                                    <span class="cbo-indicator low-cbo-circle"></span> {{ cbo.prediction }}
                                {% endif %}
                            </td>
                            <td>
                                {% if cbo.recommendations %}
                                    <ul>
                                        {% for rec in cbo.recommendations %}
                                            <li>{{ rec }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    ✅ No critical issues detected.
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>

    {% endfor %}


    <a href="/">Upload More Files</a>
    <div id="refactorModal" class="modal">
        <div class="modal-content">
            <h3 id="refactorTitle"></h3>

            <h4>Before Refactoring</h4>
            <pre><code id="beforeRefactor" class="language-java"></code></pre>

            <h4>After Refactoring</h4>
            <pre><code id="afterRefactor" class="language-java"></code></pre>

            <button onclick="closeRefactorModal()" class="btn">Close</button>
        </div>
    </div>

    <div id="customToast" class="custom-toast"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("✅ DOM fully loaded. Checking for High Complexity methods...");

            // Find the method complexity table rows
            const methodRows = document.querySelectorAll(".method-complexity-table tbody tr");

            let foundHighComplexity = false; // Flag to check if a high complexity method exists

            methodRows.forEach(row => {
                const cells = row.querySelectorAll("td"); // Get all cells in the row
                if (cells.length > 0) {
                    const categoryCell = cells[cells.length - 2]; // Second last cell (Category)
                    if (categoryCell && categoryCell.textContent.trim() === "High") {
                        foundHighComplexity = true; // Found a High Complexity method
                        console.log("⚠️ High Complexity method detected:", row);
                    }
                }
            });

            if (foundHighComplexity) {
                // Scroll smoothly to the "Method Complexity Details" section
                const methodComplexitySection = document.querySelector(".method-complexity"); // First H3 tag for section
                if (methodComplexitySection) {
                    console.log("📜 Scrolling to Method Complexity Details section...");
                    methodComplexitySection.scrollIntoView({behavior: "smooth", block: "center"});

                    // Highlight the section temporarily
                    methodComplexitySection.style.transition = "background 0.5s ease-in-out";
                    methodComplexitySection.style.background = "#ffcc00"; // Highlight
                    setTimeout(() => {
                        methodComplexitySection.style.background = "transparent";
                    }, 2000);
                } else {
                    console.warn("❌ Method Complexity Section not found!");
                }
            } else {
                console.log("✅ No High Complexity methods found.");
            }
        });

        const refactoringExamples = {
            "Refactor: Optimize loop nesting by breaking logic into smaller functions or using iterators.": {
                before: `
public void processData(List<List<Integer>> data) {
    for (List<Integer> row : data) {
        for (Integer num : row) {
            if (num > 0) {
                System.out.println(num);
            }
        }
    }
}`,
                after: `
public void processData(List<List<Integer>> data) {
    for (List<Integer> row : data) {
        processRow(row);
    }
}

private void processRow(List<Integer> row) {
    row.stream().filter(num -> num > 0).forEach(System.out::println);
}`
            },

            "Refactor: Reduce deep if-nesting by restructuring logic or using guard clauses.": {
                before: `
public void processOrder(Order order) {
    if (order != null) {
        if (order.isPaid()) {
            if (order.getItems() != null) {
                if (!order.getItems().isEmpty()) {
                    System.out.println("Processing order...");
                }
            }
        }
    }
}`,
                after: `
public void processOrder(Order order) {
    if (order == null || order.getItems() == null || order.getItems().isEmpty() || !order.isPaid()) {
        return;
    }
    System.out.println("Processing order...");
}`
            },
            "Refactor: Minimize switch-case complexity by using polymorphism or strategy pattern.": {
                before: `
public class PaymentProcessor {
    public void processPayment(String paymentType) {
        switch (paymentType) {
            case "CREDIT_CARD":
                System.out.println("Processing Credit Card...");
                break;
            case "PAYPAL":
                System.out.println("Processing PayPal...");
                break;
            case "BITCOIN":
                System.out.println("Processing Bitcoin...");
                break;
            default:
                System.out.println("Invalid Payment Type");
        }
    }
}`,
                after: `
pinterface Payment {
    void process();
}

class CreditCardPayment implements Payment {
    public void process() {
        System.out.println("Processing Credit Card...");
    }
}

class PayPalPayment implements Payment {
    public void process() {
        System.out.println("Processing PayPal...");
    }
}

class BitcoinPayment implements Payment {
    public void process() {
        System.out.println("Processing Bitcoin...");
    }
}

class PaymentProcessor {
    public void processPayment(Payment payment) {
        payment.process();
    }
}`
            },

            "Refactor: Reduce excessive try-catch nesting by isolating error-prone logic into separate functions.": {
                before: `
public void readFile(String path) {
    try {
        FileReader file = new FileReader(path);
        try {
            BufferedReader br = new BufferedReader(file);
            String line;
            while ((line = br.readLine()) != null) {
                System.out.println(line);
            }
        } catch (IOException e) {
            System.out.println("Error reading file.");
        }
    } catch (FileNotFoundException e) {
        System.out.println("File not found.");
    }
}`,
                after: `
public void readFile(String path) {
    try {
        BufferedReader br = openFile(path);
        readLines(br);
    } catch (FileNotFoundException e) {
        System.out.println("File not found.");
    } catch (IOException e) {
        System.out.println("Error reading file.");
    }
}

private BufferedReader openFile(String path) throws FileNotFoundException {
    return new BufferedReader(new FileReader(path));
}

private void readLines(BufferedReader br) throws IOException {
    String line;
    while ((line = br.readLine()) != null) {
        System.out.println(line);
    }
}`
            },
            "Refactor: Simplify complex conditions using boolean variables or encapsulating logic in functions.": {
                before: `
public boolean canAccess(User user) {
    return user != null && user.isActive() && user.getRole().equals("ADMIN") && user.getPermissions().contains("ACCESS");
}`,
                after: `
public boolean canAccess(User user) {
    if (user == null) return false;

    boolean isAdmin = user.getRole().equals("ADMIN");
    boolean hasPermission = user.getPermissions().contains("ACCESS");

    return user.isActive() && isAdmin && hasPermission;
}`
            },

            "Refactor: Reduce deep inheritance by favoring composition over inheritance.": {
                before: `
class Animal {
    void makeSound() {}
}

class Mammal extends Animal {
    void walk() {}
}

class Dog extends Mammal {
    void bark() {}
}

class Labrador extends Dog {
    void swim() {}
}`,
                after: `
class Sound {
    void makeSound() { System.out.println("Making sound"); }
}

class Movement {
    void walk() { System.out.println("Walking"); }
}

class Dog {
    private Sound sound = new Sound();
    private Movement movement = new Movement();

    void bark() { System.out.println("Barking"); }
    void walk() { movement.walk(); }
    void makeSound() { sound.makeSound(); }
}`
            },
            "Refactor: Simplify class hierarchy by breaking down large inheritance chains into composition-based structures.": {
                before: `
class Employee {
    void work() {}
}

class Manager extends Employee {
    void delegate() {}
}

class Director extends Manager {
    void makeDecisions() {}
}

class CEO extends Director {
    void strategize() {}
}`,
                after: `
interface Workable { void work(); }
interface Delegator { void delegate(); }
interface DecisionMaker { void makeDecisions(); }
interface Strategist { void strategize(); }

class Employee implements Workable {
    public void work() { System.out.println("Working"); }
}

class Manager implements Workable, Delegator {
    public void work() { System.out.println("Managing"); }
    public void delegate() { System.out.println("Delegating"); }
}

class CEO implements Workable, Strategist {
    public void work() { System.out.println("CEO Working"); }
    public void strategize() { System.out.println("Strategizing"); }
}`
            },
            "Refactor: Reduce nested if-statements and simplify complex conditions using helper functions or early returns.": {
                before: `
public boolean isValidUser(User user) {
    if (user != null) {
        if (user.getAge() > 18) {
            if (user.hasValidSubscription()) {
                return true;
            }
        }
    }
    return false;
}`,
                after: `
public boolean isValidUser(User user) {
    if (user == null) return false;
    if (user.getAge() <= 18) return false;
    return user.hasValidSubscription();
}`
            },
            "Refactor: Reduce deeply nested for-loops and simplify conditions using helper functions.": {
                before: `
public void processOrders(List<List<Order>> orders) {
    for (List<Order> orderBatch : orders) {
        for (Order order : orderBatch) {
            if (order.isPaid()) {
                if (order.hasValidAddress()) {
                    if (order.getTotalAmount() > 0) {
                        System.out.println("Processing Order: " + order.getId());
                    }
                }
            }
        }
    }
}`,
                after: `
public void processOrders(List<List<Order>> orders) {
    for (List<Order> orderBatch : orders) {
        orderBatch.stream()
            .filter(this::isValidOrder)
            .forEach(order -> System.out.println("Processing Order: " + order.getId()));
    }
}

private boolean isValidOrder(Order order) {
    return order.isPaid() && order.hasValidAddress() && order.getTotalAmount() > 0;
}`
            },
            "Refactor: Flatten try-catch blocks by handling specific exceptions separately.": {
                before: `
public void readFile(String filePath) {
    try {
        File file = new File(filePath);
        FileReader fileReader = new FileReader(file);
        BufferedReader reader = new BufferedReader(fileReader);

        String line;
        while ((line = reader.readLine()) != null) {
            System.out.println(line);
        }
        reader.close();
    } catch (FileNotFoundException e) {
        System.out.println("Error: File not found - " + e.getMessage());
    } catch (IOException e) {
        System.out.println("Error: Unable to read file - " + e.getMessage());
    } catch (Exception e) {
        System.out.println("Unexpected Error: " + e.getMessage());
    }
}`,
                after: `
public void readFile(String filePath) {
    try (BufferedReader reader = new BufferedReader(new FileReader(new File(filePath)))) {
        reader.lines().forEach(System.out::println);
    } catch (FileNotFoundException e) {
        handleFileNotFound(e);
    } catch (IOException e) {
        handleIOException(e);
    } catch (Exception e) {
        handleUnexpectedError(e);
    }
}

private void handleFileNotFound(FileNotFoundException e) {
    System.out.println("Error: File not found - " + e.getMessage());
}

private void handleIOException(IOException e) {
    System.out.println("Error: Unable to read file - " + e.getMessage());
}

private void handleUnexpectedError(Exception e) {
    System.out.println("Unexpected Error: " + e.getMessage());
}`
            }
        };

        function showRefactorExample(refactorLabel) {
            if (refactoringExamples[refactorLabel]) {
                document.getElementById('refactorTitle').textContent = `${refactorLabel}`;
                document.getElementById('beforeRefactor').textContent = refactoringExamples[refactorLabel].before;
                document.getElementById('afterRefactor').textContent = refactoringExamples[refactorLabel].after;
                document.getElementById('refactorModal').style.display = 'flex';

                Prism.highlightAll();
            } else {
                alert("No refactoring example available for this label.");
            }
        }

        function closeRefactorModal() {
            document.getElementById('refactorModal').style.display = 'none';
        }

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("🔥 DOM fully loaded. Checking for content...");

            // Check if complexities exist in the DOM
            const complexitiesContainer = document.querySelector(".metrics");
            if (complexitiesContainer) {
                console.log("✅ Complexity details found!");

                // Call the toast function when all details are loaded
                setTimeout(() => {
                    console.log("⏳ Calling showCustomToast()...");
                    showCustomToast("✅ Java Code Complexity Calculated Successfully!");
                }, 1000); // Add a small delay to simulate loading
            } else {
                console.warn("⚠️ No complexity details found. Skipping toast.");
            }
        });

        function showCustomToast(message) {
            console.log("🔥 showCustomToast() function called!");

            const toast = document.getElementById('customToast');
            if (!toast) {
                console.error("❌ ERROR: Toast element not found!");
                return;
            }

            console.log("✅ Toast element found!");

            // Ensure it's visible before applying animation
            toast.style.display = 'block';
            setTimeout(() => {
                toast.textContent = message;
                toast.classList.add('show-toast');
                console.log("🎉 Toast is now visible!");
            }, 10); // Small delay to trigger animation

            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show-toast');
                console.log("⌛ Hiding toast...");
                setTimeout(() => {
                    toast.style.display = 'none';
                    console.log("❌ Toast is now hidden.");
                }, 500); // Matches the CSS transition
            }, 3000);
        }
    </script>

    <div id="barChartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalMethodName"></h3>
                <span class="close" onclick="closeBarChartModal()">&times;</span>
            </div>
            <img id="modalBarChart" src="" alt="Bar Chart">
        </div>
    </div>

    <div id="chartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalChartTitle"></h3>
                <span class="close" onclick="closePieChartModal()">&times;</span>
            </div>
            <img id="modalPieChart" src="" alt="Pie Chart">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>

        const toggle = document.getElementById('toggle');
        const body = document.body;

        toggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            toggle.classList.toggle('dark');
        });

        document.addEventListener("DOMContentLoaded", function () {
            console.log("DOM Loaded. Modal should be available.");
        });

        document.addEventListener('DOMContentLoaded', () => {
            const recommendationRows = document.querySelectorAll('.recommendation-row');
            recommendationRows.forEach(row => {
                const recommendationText = row.querySelector('.recommendation-text').textContent;
                console.log(recommendationText);
                if (recommendationText.toLowerCase().includes('urgent refactor')) {
                    console.log("Hi");
                    alert(`Urgent refactor recommendation found: ${recommendationText}`);
                }
            });
        });

        function showCustomToast(message) {
            console.log("🔥 showCustomToast() function called!");

            const toast = document.getElementById('customToast');
            if (!toast) {
                console.error("❌ ERROR: Toast element not found!");
                return;
            }

            console.log("✅ Toast element found!");

            // Ensure it's visible before applying animation
            toast.style.display = 'block';
            setTimeout(() => {
                toast.textContent = message;
                toast.classList.add('show-toast');
                console.log("🎉 Toast is now visible!");
            }, 10); // Small delay to trigger animation

            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show-toast');
                console.log("⌛ Hiding toast...");
                setTimeout(() => {
                    toast.style.display = 'none';
                    console.log("❌ Toast is now hidden.");
                }, 500); // Matches the CSS transition
            }, 3000);
        }

        // Ensure toast appears on page load (simulating successful retrieval)
        document.addEventListener('DOMContentLoaded', () => {
            console.log("🔥 DOM is fully loaded!");
            setTimeout(() => {
                console.log("⏳ Calling showCustomToast()...");
                showCustomToast("✅ Details retrieved successfully!");
            }, 1000);
        });


        function showBarChart(methodName, chartPath) {
            // Set the method name and bar chart in the modal
            document.getElementById('modalMethodName').textContent = `Bar Chart for Method: ${methodName}`;
            document.getElementById('modalBarChart').src = `/static/images/${chartPath}`;
            // Display the modal
            document.getElementById('barChartModal').style.display = 'flex';
        }

        function showPieChart(filename, pieChartData) {
            document.getElementById('modalChartTitle').textContent = `Pie Chart for Class: ${filename}`;
            document.getElementById('modalPieChart').src = `/static/images/${pieChartData}`;
            // Display the modal
            document.getElementById('chartModal').style.display = 'flex';
        }

        // Close functions for each modal
        function closeBarChartModal() {
            document.getElementById('barChartModal').style.display = 'none';
        }

        function closePieChartModal() {
            document.getElementById('chartModal').style.display = 'none';
        }

        // Global click event to close modals when clicking outside their content
        window.onclick = function (event) {
            const barChartModal = document.getElementById('barChartModal');
            const chartModal = document.getElementById('chartModal');
            if (event.target === barChartModal) {
                closeBarChartModal();
            }
            if (event.target === chartModal) {
                closePieChartModal();
            }
        }

    </script>

{% endblock %}
