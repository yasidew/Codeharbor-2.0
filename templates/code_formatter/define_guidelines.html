{% extends 'base.html' %}
{% load static %}

{% block sidebar %}
    <div class="sidebar" data-color="black">
        <div class="sidebar-wrapper">
            <div class="logo">
                <a href="#" class="simple-text logo-mini">
                    <img src="{% static 'images/code-harbor-logo.png' %}" alt="Code Harbor Logo" width="30">
                </a>
                <a href="#" class="simple-text logo-normal">Code Harbor</a>
            </div>
            <ul class="nav">
                <li><a href="{% url 'refactor_view' %}"><i class="bi bi-code-slash"></i>
                    <p>Refactor Code</p></a></li>
                <li><a href="{% url 'define_guidelines' %}"><i class="bi bi-pencil"></i>
                    <p>Define Guidelines</p></a></li>
                <li><a href="#"><i class="bi bi-bar-chart"></i>
                    <p>Analysis</p></a></li>
                <li><a href="#"><i class="bi bi-gear"></i>
                    <p>Settings</p></a></li>
                <li><a href="#"><i class="bi bi-box-arrow-right"></i>
                    <p>Logout</p></a></li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <h2 class="text-white text-center">Define Guidelines</h2>
        <form method="POST" action="{% url 'define_guidelines' %}">
            {% csrf_token %}

            <div class="form-group">
                <label class="text-white">Company Name:</label>
                <input type="text" name="company_name" class="form-control mb-2" required>
            </div>

            <div class="form-group">
                <label class="text-white">Pattern:</label>
                <select id="pattern-selector" name="pattern" class="form-control mb-2 custom-dropdown">
                    <option value="" selected disabled>-- Select a Pattern --</option>
                    <option value="Factory">Factory Pattern</option>
                    <option value="Strategy">Strategy Pattern</option>
                    <option value="Observer">Observer Pattern</option>
                </select>
            </div>

            <div class="form-group">
                <label class="text-white">Guideline:</label>
                <textarea id="guideline-text" name="rule" class="form-control mb-2 resizable-textarea"
                          required></textarea>
                <button type="button" id="regenerate-btn" class="btn btn-warning btn-sm mt-2" disabled>ðŸ”„ Regenerate
                    Suggestion
                </button>
            </div>

            <button type="submit" class="btn btn-info">Save Guideline</button>
        </form>

        <!-- Saved Guidelines Section -->
        <h3 class="text-white text-center mt-4">Saved Guidelines</h3>
        <div id="guidelines-container">
            {% for guideline in guidelines %}
                <div class="card bg-dark text-white p-3 mb-3">
                    <div id="view-mode-{{ guideline.id }}">
                        <strong>{{ guideline.company_name }}</strong>
                        <p>Pattern: {{ guideline.pattern }}</p>
                        {#                        <p>{{ guideline.rule }}</p>#}
                        <div>
                            {% if guideline.rule|slice:":2" == "1." %}
                                <ol>
                                    {% for line in guideline.rule.splitlines %}
                                        {% if line|length > 0 %}
                                            <li>{{ line }}</li>
                                        {% endif %}
                                    {% endfor %}
                                </ol>
                            {% else %}
                                {% for line in guideline.rule.splitlines %}
                                    {% if line|length > 0 %}
                                        <p>{{ line }}</p>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button class="btn btn-warning btn-sm edit-btn" data-id="{{ guideline.id }}">Edit</button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="{{ guideline.id }}">Delete</button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const patternSelector = document.getElementById("pattern-selector");
            const guidelineText = document.getElementById("guideline-text");
            const regenerateBtn = document.getElementById("regenerate-btn");

            async function fetchAISuggestion(pattern) {
                guidelineText.value = "Fetching AI suggestion... ðŸ”„";
                try {
                    const response = await fetch("/code-formatter/generate-guideline/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({pattern})
                    });

                    if (response.ok) {
                        const data = await response.json();
                        guidelineText.value = data.suggestion || "AI could not generate a suggestion.";
                        regenerateBtn.disabled = false; // Enable regenerate button
                    } else {
                        guidelineText.value = "Error fetching AI suggestion. Try again.";
                        regenerateBtn.disabled = true;
                    }
                } catch (error) {
                    guidelineText.value = "An error occurred.";
                    regenerateBtn.disabled = true;
                }
            }

            // Fetch AI suggestion when a pattern is selected
            patternSelector.addEventListener("change", function () {
                if (this.value) {
                    fetchAISuggestion(this.value);
                }
            });

            // Regenerate AI suggestion when button is clicked
            regenerateBtn.addEventListener("click", function () {
                if (patternSelector.value) {
                    fetchAISuggestion(patternSelector.value);
                }
            });
        });
    </script>

    <style>
        .resizable-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .custom-dropdown {
            appearance: none;
            background-color: #222;
            color: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #666;
        }

        .custom-dropdown option {
            background-color: #222;
            color: white;
        }

        .card {
            border-radius: 8px;
        }

        .card p {
            white-space: pre-line; /* Preserves line breaks */
            line-height: 1.6; /* Adds spacing between lines */
            margin-bottom: 8px; /* Adds spacing between paragraphs */
        }

        .card ol {
            padding-left: 20px; /* Indentation for ordered list */
        }

        .card li {
            margin-bottom: 5px; /* Adds spacing between each list item */
        }
    </style>
{% endblock %}
