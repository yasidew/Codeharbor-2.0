{% extends 'base.html' %}
{% load static %}

{% block sidebar %}
    <div class="sidebar" data-color="black">
        <div class="sidebar-wrapper">
            <div class="logo">
                <a href="#" class="simple-text logo-mini">
                    <img src="{% static 'images/code-harbor-logo.png' %}" alt="Code Harbor Logo" width="30">
                </a>
                <a href="#" class="simple-text logo-normal">Code Harbor</a>
            </div>
            <ul class="nav">
                <li><a href="{% url 'refactor_view' %}"><i class="bi bi-code-slash"></i>
                    <p>Refactor Code</p></a></li>
                <li>
                    <a href="#" class="upload-btn"><i class="bi bi-upload"></i>
                        <p>Upload Code</p>
                    </a>
                    <input type="file" name="file" id="fileInput" class="d-none">
                </li>
                <li><a href="{% url 'define_guidelines' %}"><i class="bi bi-pencil"></i>
                    <p>Define Guidelines</p></a></li>
                <li><a href="#"><i class="bi bi-bar-chart"></i>
                    <p>Analysis</p></a></li>
                <li><a href="#"><i class="bi bi-gear"></i>
                    <p>Settings</p></a></li>
                <li><a href="#"><i class="bi bi-box-arrow-right"></i>
                    <p>Logout</p></a></li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="content d-flex align-items-center justify-content-center min-vh-100">
        <div class="container">
            <h2 class="text-center text-white mb-4">Code Refactoring Tool</h2>

            <!-- Toggle to Enable/Disable Guidelines -->
            <!-- Toggle to Enable/Disable Guidelines -->
            <div class="text-center mb-4">
                <label class="toggle-switch">
                    <input type="checkbox" id="guideline-toggle">
                    <span class="slider"></span>
                </label>
                <span class="text-white ms-2">Use Guidelines</span>
            </div>

            <!-- Monaco Code Editor for Original Code -->
            <div class="card bg-dark p-4">
                <h5 class="text-white">Original Code</h5>
                <div id="monacoEditor" class="editor-container"></div>
            </div>

            <!-- Refactor Button -->
            <div class="text-center mt-3">
                <button id="refactor-btn" class="btn btn-info">Refactor Code</button>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-bar" class="mt-3 text-center" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <p class="text-white mt-2">Refactoring your code...</p>
            </div>

            <!-- Before-After Code Diff View -->
            <div id="diff-section" class="mt-5" style="display: none;">
                <h3 class="text-center text-white">Before & After Code Comparison</h3>
                <div class="card bg-dark p-3">
                    <div id="codeDiffViewer" class="editor-container"></div>
                </div>
            </div>

            <!-- Refactored Code Output -->
            <div id="refactored-section" class="mt-5" style="display: none;">
                <h3 class="text-center text-white">Refactored Code</h3>
                <div class="card bg-dark p-3">
                    <div id="monacoRefactoredEditor" class="editor-container"></div>
                </div>

                <!-- Changes Summary -->
                <div id="changes-section" class="mt-4" style="display: none;">
                    <h4 class="text-white">Changes Made:</h4>
                    <ul id="changes-list" class="text-white"></ul>
                </div>

                <div class="text-center mt-3">
                    <button id="download-btn" class="btn btn-success">Download Refactored Code</button>
                </div>
            </div>

            <!-- Code Metrics -->
            <div id="metrics-section" class="mt-5" style="display: none;">
                <h3 class="text-center text-white">Code Metrics Visualization</h3>
                <canvas id="metricsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Include Monaco Editor & Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let editor, refactoredEditor, diffEditor;

        require.config({paths: {'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs'}});

        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('monacoEditor'), {
                value: "// Paste or upload your code here...",
                language: "javascript",
                theme: "vs-dark",
                automaticLayout: true,
                fontSize: 14
            });

            refactoredEditor = monaco.editor.create(document.getElementById('monacoRefactoredEditor'), {
                value: "",
                language: "javascript",
                theme: "vs-dark",
                readOnly: true,
                automaticLayout: true,
                fontSize: 14
            });

            diffEditor = monaco.editor.createDiffEditor(document.getElementById('codeDiffViewer'), {
                theme: "vs-dark",
                readOnly: true
            });
        });

        document.getElementById('refactor-btn').addEventListener('click', async () => {
            const code = editor.getValue();
            const useGuidelines = document.getElementById('guideline-toggle').checked;

            const loadingBar = document.getElementById('loading-bar');
            const refactoredSection = document.getElementById('refactored-section');
            const changesSection = document.getElementById('changes-section');
            const changesList = document.getElementById('changes-list');

            loadingBar.style.display = 'block';
            refactoredSection.style.display = 'none';
            changesSection.style.display = 'none';
            changesList.innerHTML = '';  // Clear previous changes

            try {
                const response = await fetch('/code-formatter/refactor-code/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({code, use_guidelines: useGuidelines}),
                });

                const data = await response.json();

                if (response.ok) {
                    // Extract the code part and set it in the editor
                    const extractedCode = extractCode(data.refactored_code);
                    refactoredEditor.setValue(extractedCode);

                    // Display changes separately
                    if (data.changes) {
                        data.changes.forEach(change => {
                            const li = document.createElement('li');
                            li.textContent = change;
                            changesList.appendChild(li);
                        });
                        changesSection.style.display = 'block';
                    }

                    refactoredSection.style.display = 'block';
                } else {
                    alert("Error in refactoring code!");
                }
            } catch (error) {
                alert("An error occurred: " + error.message);
            } finally {
                loadingBar.style.display = 'none';
            }
        });

        // Function to extract only the code block
        function extractCode(responseText) {
            const codeRegex = /```java([\s\S]*?)```/;
            const match = responseText.match(codeRegex);
            return match ? match[1].trim() : responseText;
        }

        // Handle File Upload
        document.querySelector('.upload-btn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) {
                return; // No file selected
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                editor.setValue(e.target.result); // Set file content in Monaco Editor
            };
            reader.readAsText(file);
        });

        function generateChart(originalLOC, refactoredLOC, originalReadability, refactoredReadability) {
            const ctx = document.getElementById('metricsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Original LOC', 'Refactored LOC', 'Original Readability', 'Refactored Readability'],
                    datasets: [{
                        label: 'Metrics Comparison',
                        data: [originalLOC, refactoredLOC, originalReadability, refactoredReadability],
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0'],
                    }]
                }
            });
        }
    </script>
    <style>
        /* Monaco Editor Full Size */
        .editor-container {
            width: 100%;
            height: calc(100vh - 200px); /* Adjust dynamically */
            border-radius: 5px;
            overflow: visible !important; /* Allow suggestions to expand freely */
        }

        /* Fix Sidebar Button Style */
        .upload-btn {
            display: flex;
            align-items: center;
            text-decoration: none;
            padding: 10px 15px;
            color: white;
        }

        /* Ensure Upload Code button matches others without the hover effect */
        .upload-btn:hover {
            background: none !important;
            border-radius: 0 !important;
        }

        /* Prevent horizontal scrolling */
        html, body {
            overflow-x: hidden;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 25px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 17px;
            width: 17px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(25px);
        }


    </style>
{% endblock %}
