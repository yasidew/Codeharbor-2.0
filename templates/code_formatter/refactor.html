{% extends 'base.html' %}

{% block content %}
<h1 class="text-center mb-4">Code Refactoring Tool</h1>
<div class="container">
    <!-- Original Code Input -->
    <div class="mb-3">
        <label for="fileInput" class="form-label">Upload or Paste Code Below:</label>
        <input type="file" name="file" id="fileInput" class="form-control mb-3">
        <textarea id="codeEditor" name="code" class="form-control"></textarea>
    </div>

    <!-- Refactor Button -->
    <div class="text-center">
        <button id="refactor-btn" class="btn btn-success">Refactor Code</button>
    </div>

    <!-- Loading Bar -->
    <div id="loading-bar" class="mt-3" style="display: none;">
        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%;"></div>
        </div>
    </div>

    <!-- Refactored Code Output -->
    <div id="refactored-section" class="mt-5" style="display: none;">
        <h3 class="text-center">Refactored Code</h3>
        <textarea id="refactoredCodeEditor" class="form-control" readonly></textarea>
        <div class="text-center mt-3">
            <button id="download-btn" class="btn btn-primary">Download Refactored Code</button>
        </div>
    </div>

    <!-- Code Metrics -->
    <div id="metrics-section" class="mt-5" style="display: none;">
        <h3 class="text-center">Code Metrics Visualization</h3>
        <canvas id="metricsChart" width="400" height="200"></canvas>
    </div>
</div>

<!-- Include CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>

<script>
    // Initialize CodeMirror for Original Code
    const codeMirrorEditor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
        lineNumbers: true,
        mode: "javascript",
        theme: "default",
    });

    // Initialize CodeMirror for Refactored Code
    const refactoredCodeMirror = CodeMirror.fromTextArea(document.getElementById('refactoredCodeEditor'), {
        lineNumbers: true,
        mode: "javascript",
        theme: "default",
        readOnly: true,
    });

    // Handle File Upload
    document.getElementById('fileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                codeMirrorEditor.setValue(e.target.result);
            };
            reader.readAsText(file);
        }
    });

    // Handle Refactor Button Click
    document.getElementById('refactor-btn').addEventListener('click', async () => {
        const code = codeMirrorEditor.getValue();
        const loadingBar = document.getElementById('loading-bar');
        const refactoredSection = document.getElementById('refactored-section');
        const metricsSection = document.getElementById('metrics-section');

        loadingBar.style.display = 'block';
        refactoredSection.style.display = 'none';
        metricsSection.style.display = 'none';

        try {
            const response = await fetch('/code-formatter/refactor-code/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ code }),
            });

            if (response.ok) {
                const data = await response.json();
                refactoredCodeMirror.setValue(data.refactored_code);

                // Display sections on success
                refactoredSection.style.display = 'block';
                metricsSection.style.display = 'block';

                // Display Toast for Success
                showToast("Code refactoring successful!", "success");

                // Update Chart with Metrics
                generateChart(data.original_loc, data.refactored_loc, data.original_readability, data.refactored_readability);
            } else {
                showToast("Error in refactoring code!", "error");
            }
        } catch (error) {
            showToast("An error occurred: " + error.message, "error");
        } finally {
            loadingBar.style.display = 'none';
        }
    });

    // Download Refactored Code
    document.getElementById('download-btn').addEventListener('click', () => {
        const refactoredCode = refactoredCodeMirror.getValue();
        const blob = new Blob([refactoredCode], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'refactored_code.java';
        link.click();
    });

    // Generate Metrics Chart
    function generateChart(originalLOC, refactoredLOC, originalReadability, refactoredReadability) {
    const ctx = document.getElementById('metricsChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Original LOC', 'Refactored LOC', 'Original Readability', 'Refactored Readability'],
            datasets: [{
                label: 'Metrics Comparison',
                data: [originalLOC, refactoredLOC, originalReadability, refactoredReadability],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',  // Semi-transparent red
                    'rgba(54, 162, 235, 0.5)',  // Semi-transparent blue
                    'rgba(255, 206, 86, 0.5)',  // Semi-transparent yellow
                    'rgba(75, 192, 192, 0.5)'   // Semi-transparent teal
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',    // Solid red border
                    'rgba(54, 162, 235, 1)',    // Solid blue border
                    'rgba(255, 206, 86, 1)',    // Solid yellow border
                    'rgba(75, 192, 192, 1)'     // Solid teal border
                ],
                borderWidth: 1,
            }],
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true },
            },
        },
    });
}

    // Show Toast Message
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerText = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = 0;
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>

<style>
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #000;
        color: #fff;
        padding: 10px 15px;
        border-radius: 5px;
        z-index: 1000;
        transition: opacity 0.3s ease-in-out;
        opacity: 0.9;
    }
    .toast.success {
        background: #28a745;
    }
    .toast.error {
        background: #dc3545;
    }
</style>
{% endblock %}
