{% extends 'base.html' %}
{% load static %}
{% block title %}Code Refactoring{% endblock %}
{% block sidebar %}
    <div class="sidebar" data-color="black">
        <div class="sidebar-wrapper">
            <div class="logo">
                <a href="http://127.0.0.1:8000" class="simple-text logo-mini">
                    <img src="{% static 'images/code-harbor-logo.png' %}" alt="Code Harbor Logo" width="30">
                </a>
                <a href="http://127.0.0.1:8000" class="simple-text logo-normal">Code Harbor</a>
            </div>
            <ul class="nav">
                <li><a href="{% url 'refactor_view' %}"><i class="bi bi-code-slash"></i>
                    <p>Refactor Code</p></a></li>
                <li>
                    <a href="#" class="upload-btn"><i class="bi bi-upload"></i>
                        <p>Upload Code</p>
                    </a>
                    <input type="file" name="file" id="fileInput" class="d-none">
                </li>
                <li><a href="{% url 'define_guidelines' %}"><i class="bi bi-pencil"></i>
                    <p>Define Guidelines</p></a></li>
                <!-- ✅ Import Code from GitHub Trigger -->
                <li>
                    <a href="{% url 'github_import_modal' %}" onclick="loadModal(); return false;">
                        <i class="bi bi-github"></i>
                        <p>Import from GitHub</p>
                    </a>
                </li>
                <li><a href="#"><i class="bi bi-bar-chart"></i>
                    <p>Analysis</p></a></li>
                <!-- ✅ Add Resources with a proper icon -->
                <li>
                    <a href="{% url 'add_resource' %}"><i class="bi bi-plus-square"></i>
                        <p>Add Resources</p>
                    </a>
                </li>

                <!-- ✅ View Resources with a proper icon -->
                <li>
                    <a href="{% url 'list_resources' %}"><i class="bi bi-book"></i>
                        <p>View Resources</p>
                    </a>
                </li>
                <li><a href="#"><i class="bi bi-gear"></i>
                    <p>Settings</p></a></li>
                <li><a href="#"><i class="bi bi-box-arrow-right"></i>
                    <p>Logout</p></a></li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="content d-flex align-items-center justify-content-center min-vh-100">
        <div class="container">
            {#            <h2 class="text-center text-white mb-4">Code Refactoring</h2>#}
            {##}
            {#            <!-- Toggle to Enable/Disable Guidelines -->#}
            {#            <div class="d-flex align-items-center justify-content-center mb-4" style="gap: 1.5rem;">#}
            {#                <label class="toggle-switch m-0">#}
            {#                    <input type="checkbox" id="guideline-toggle">#}
            {#                    <span class="slider"></span>#}
            {#                </label>#}
            {#                <span class="text-white">Use Guidelines</span>#}
            {#            </div>#}
            <!-- 🔥 2️⃣ Code Refactoring Header (Updated) -->
            <h2 class="text-center text-white mb-4"
                style="border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Code Refactoring</h2>
            <div class="d-flex align-items-center justify-content-center mb-4" style="gap: 1.5rem;">
                <label class="toggle-switch m-0">
                    <input type="checkbox" id="guideline-toggle">
                    <span class="slider"></span>
                </label>
                <span class="text-white">Use Guidelines</span>
            </div>

            <!-- Suggested Design Pattern (Modern UI) -->
            <div id="suggested-pattern" class="pattern-badge d-flex align-items-center mb-3" style="display: none;">
                <span class="badge-text">Suggested Design Pattern:</span>
                <span id="pattern-name" class="pattern-name"></span>
            </div>

            {#            <!-- Monaco Code Editor for Original Code -->#}
            {#            <div class="card bg-dark p-4">#}
            {#                <h5 class="text-white">Original Code</h5>#}
            {#                <div id="monacoEditor" class="editor-container"></div>#}
            {#            </div>#}
            <!-- 🔥 3️⃣ Monaco Code Editor (Updated) -->
            <div class="card bg-dark p-4" style="border-radius: 10px; box-shadow: 0 0 12px rgba(0,255,255,0.1);">
                <h3 class="text-center text-white">Original Code</h3>
                <div id="monacoEditor" class="editor-container" style="position: relative;"></div>
            </div>

            <!-- Refactor Button -->
            {#            <div class="text-center mt-3">#}
            {#                <button id="refactor-btn"#}
            {#                        class="btn btn-info btn-lg fw-bold text-white shadow-lg border-0"#}
            {#                        style="background: linear-gradient(90deg, #007bff, #0056b3);#}
            {#               transition: all 0.3s ease;">#}
            {#                    Refactor Code#}
            {#                </button>#}
            {#            </div>#}
            <!-- 🔥 4️⃣ Refactor Button (Updated) -->
            <div class="text-center mt-3">
                <button id="refactor-btn" class="btn btn-lg fw-bold text-white shadow-lg border-0 refactor-btn"
                        style="background: linear-gradient(90deg, #007bff, #0056b3);
               transition: all 0.3s ease;">
                    ⚡ Refactor Code
                </button>
            </div>
            <br>
            <br>

            <!-- Loading Spinner -->
            {#            <div id="loading-bar" class="mt-3 text-center" style="display: none;">#}
            {#                <div class="spinner-border text-primary" role="status">#}
            {#                    <span class="visually-hidden">Processing...</span>#}
            {#                </div>#}
            {#                <p class="text-white mt-2">Refactoring your code...</p>#}
            {#            </div>#}
            <!-- Updated Loading Spinner -->
            <div id="loading-bar" class="mt-3 text-center" style="display: none;">
                <div class="dots-loader">
                    <span class="red"></span>
                    <span class="yellow"></span>
                    <span class="green"></span>
                    <span class="blue"></span>
                </div>
                <p class="text-white mt-2">Refactoring your code...</p>
            </div>

            {#            <!-- Before-After Code Diff View -->#}
            {#            <div id="diff-section" class="mt-5" style="display: none;">#}
            {#                <h3 class="text-center text-white">Before & After Code Comparison</h3>#}
            {#                <div id="codeDiffViewer" style="height: 500px; width: 100%;"></div>#}
            {#                <div id="monacoDiffEditor" style="height: 500px; width: 100%;"></div>#}
            {#            </div>#}
            <!-- 🔥 5️⃣ Before & After Code Comparison (Updated) -->
            <div id="diff-section" class="card bg-dark p-4"
                 style="display: none; border-radius: 10px; box-shadow: 0 0 12px rgba(0,255,255,0.1);">
                <h3 class="text-center text-white">Before & After Code Comparison</h3>
                <div id="monacoDiffEditor" class="editor-container" style="position: relative;"></div>
            </div>


            <!-- Refactored Code Output -->
            <div id="refactored-section" class="mt-5" style="display: none;">
                {#                <h3 class="text-center text-white">Refactored Code</h3>#}
                {#                <div class="card bg-dark p-3">#}
                {#                    <div id="monacoRefactoredEditor" class="editor-container"></div>#}
                {#                </div>#}
                <!-- 🔥 6️⃣ Refactored Code Section (Updated) -->
                <div class="card bg-dark p-4"
                     style="border-radius: 10px; border-radius: 10px; box-shadow: 0 0 12px rgba(0,255,255,0.1);">
                    <h3 class="text-center text-white">Refactored Code</h3>
                    <div id="monacoRefactoredEditor" class="editor-container" style="position: relative;"></div>
                    <br>
                    <br>
                    <div id="changes-section" class="mt-4"
                         style="display: none; border-radius: 10px; border-radius: 10px;">
                        <h4 class="text-center text-white mb-3">Changes Made</h4>
                        <div id="changesContainer" class="d-flex flex-column gap-3"></div>
                    </div>
                </div>


                <!-- Changes Summary -->
                {#                <div id="changes-section" class="mt-4"#}
                {#                     style="display: none; border-radius: 10px; border-radius: 10px; box-shadow: 0 0 12px rgba(0,255,255,0.1);">#}
                {#                    <h4 class="text-center text-white mb-3">Changes Made</h4>#}
                {#                    <div id="changesContainer" class="d-flex flex-column gap-3"></div>#}
                {#                </div>#}

                <!-- Design Pattern Used -->
                {#                <div id="design-pattern-text" class="text-center text-warning mt-3" style="display: none;"></div>#}


                <div class="text-center mt-3">
                    <button id="download-btn" class="btn btn-success">Download Refactored Code</button>
                </div>
            </div>
            <br>
            <br>


            <!-- Code Metrics Section -->
            <div id="metrics-section" class="card bg-dark p-4"
                 style="display: none; border-radius: 10px; border-radius: 10px; box-shadow: 0 0 12px rgba(0,255,255,0.1);">
                <h3 class="text-center text-white">Code Refactoring Analysis</h3>
                <p class="text-muted text-center">A visual comparison of refactoring improvements.</p>

                <div class="row gx-4 gy-4 mt-4">
                    <div class="col-md-6">
                        <div class="card bg-dark p-3 shadow-lg rounded">
                            <h5 class="text-center text-white">Code Metrics Comparison</h5>
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-dark p-3 shadow-lg rounded">
                            <h5 class="text-center text-white">Improvement Breakdown</h5>
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card bg-dark p-3 shadow-lg rounded text-center">
                            <h5 class="text-white">Maintainability Index</h5>
                            <canvas id="gaugeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal for Code Metrics Explanation -->
            <div id="codeMetricsModal" class="custom-modal">
                <div class="custom-modal-content">
                    <span class="close-btn" onclick="closeMetricsModal()">&times;</span>
                    <h3 class="modal-title">Code Metrics Analysis</h3>
                    <div id="modal-chart-container">
                        <canvas id="modalChart"></canvas>
                    </div>
                    <div id="explanation-content">
                        <p>Loading explanation...</p>
                    </div>
                </div>
            </div>

            <!-- Suggested Learning Resources -->
            <div id="resources-section" class="resource-card" style="display: none;">
                <div class="resource-header">
                    <i class="bi bi-lightbulb"></i> Suggested Learning Resources
                </div>
                <div class="resource-content">
                    <p><i class="bi bi-pin"></i> <strong>Pattern Name:</strong> <span id="pattern-name-text"></span></p>
                    <p><i class="bi bi-folder"></i> <strong>Category:</strong> <span id="pattern-category"></span></p>
                    <p><i class="bi bi-file-earmark-text"></i> <strong>Description:</strong> <span
                            id="pattern-description"></span></p>
                </div>
                <div class="resource-footer">
                    <a id="pattern-link" href="#" target="_blank" class="resource-btn">
                        🚀 Learn More
                    </a>
                </div>
            </div>

        </div>
    </div>

    <!-- ✅ GitHub Import Modal (Added at the Bottom of Content) -->
    <!-- Container to Load Modal -->
    <div id="modal-container"></div>

    <!-- Bootstrap JS for Collapsible + icons for chevrons -->
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+5c5cj0I9PHK3i1b+8SlE71i9u7xS"
            crossorigin="anonymous">
    </script>

    <!-- Include Monaco Editor & Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Include diff2html CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css">
    <!-- Include diff2html JS -->
    <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let editor, refactoredEditor, diffEditor, monacoDiffEditor;

        require.config({paths: {'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs'}});

        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('monacoEditor'), {
                value: "// Paste or upload your code here...",
                language: "javascript",
                theme: "vs-dark",
                automaticLayout: true,
                fontSize: 14
            });

            refactoredEditor = monaco.editor.create(document.getElementById('monacoRefactoredEditor'), {
                value: "",
                language: "javascript",
                theme: "vs-dark",
                readOnly: true,
                automaticLayout: true,
                fontSize: 14
            });

            {#diffEditor = monaco.editor.createDiffEditor(document.getElementById('codeDiffViewer'), {#}
            {#    theme: "vs-dark",#}
            {#    readOnly: true});#}


            monacoDiffEditor = monaco.editor.createDiffEditor(document.getElementById('monacoDiffEditor'), {
                theme: "vs-dark",
                readOnly: true,
                automaticLayout: true
            });


            // Detect when the user enters code and trigger pattern detection
            editor.onDidChangeModelContent(async () => {
                const code = editor.getValue();
                if (code.trim().length > 5) {  // Avoid triggering for empty input
                    fetchDesignPattern(code);
                } else {
                    document.getElementById("suggested-pattern").style.display = "none";
                }
            });
        });

        async function showCodeDiff(recordId) {
            try {
                const response = await fetch(`/code-formatter/fetch-snippet-diff/?record_id=${recordId}`);
                const result = await response.json();

                if (result.success) {
                    const originalCode = result.original_code || "No original code available.";
                    const refactoredCode = result.refactored_code || "No refactored code available.";

                    // Ensure Monaco models are created properly
                    const originalModel = monaco.editor.createModel(originalCode, "java");
                    const modifiedModel = monaco.editor.createModel(refactoredCode, "java");

                    // Initialize Monaco Diff Editor if not already done
                    if (!monacoDiffEditor) {
                        monacoDiffEditor = monaco.editor.createDiffEditor(document.getElementById('monacoDiffEditor'), {
                            theme: "vs-dark",
                            readOnly: true,
                            automaticLayout: true
                        });
                    }

                    // Set the models in the diff editor
                    monacoDiffEditor.setModel({
                        original: originalModel,
                        modified: modifiedModel
                    });

                    document.getElementById("diff-section").style.display = "block";
                } else {
                    console.error("Error fetching diff:", result.error);
                }
            } catch (err) {
                console.error("Error fetching diff:", err.message);
            }
        }


        document.getElementById('refactor-btn').addEventListener('click', async () => {
            const code = editor.getValue();
            const useGuidelines = document.getElementById('guideline-toggle').checked;

            const loadingBar = document.getElementById('loading-bar');
            const refactoredSection = document.getElementById('refactored-section');
            const changesSection = document.getElementById('changes-section');
            const metricsSection = document.getElementById('metrics-section');
            {#const changesList = document.getElementById('changes-list');#}
            // CHANGED #2: We'll target "changesContainer" for collapsible cards
            const changesContainer = document.getElementById('changesContainer');
            const resourcesSection = document.getElementById('resources-section');
            const resourcesList = document.getElementById('resources-list');
            const designPatternText = document.getElementById('design-pattern-text');

            loadingBar.style.display = 'block';
            refactoredSection.style.display = 'none';
            changesSection.style.display = 'none';
            metricsSection.style.display = 'none';
            resourcesSection.style.display = 'none'; // Hide resources section

            changesContainer.innerHTML = "";// Clear previous changes

            try {
                const response = await fetch('/code-formatter/refactor-code/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({code, use_guidelines: useGuidelines}),
                });

                const data = await response.json();

                if (response.ok) {
                    refactoredEditor.setValue(data.refactored_code);
                    refactoredSection.style.display = 'block';
                    showCodeDiff(data.id);
                    fetchMetrics(data.id);

                    // Build collapsible "cards" for each change
                    if (data.changes_made && data.changes_made.length > 0) {
                        data.changes_made.forEach((rawChangeText, index) => {
                            // remove leading dash
                            const changeText = rawChangeText.replace(/^[-\s]+/, '');

                            const cardHTML = `
                          <div class="sleek-card position-relative text-white my-2">
                            <div class="accent-shape"></div>
                            <div class="d-flex justify-content-between align-items-center p-3 clickable-row"
                                 data-bs-toggle="collapse"
                                 data-bs-target="#collapse-${index}"
                                 aria-expanded="false"
                                 aria-controls="collapse-${index}"
                                 style="cursor: pointer; z-index: 2;">
                              <div class="d-flex align-items-center" style="z-index:2;">
                                <i class="me-2 text-warning fs-4"></i>
                                <span class="fs-6">${changeText}</span>
                              </div>
{#                              <i class="bi bi-chevron-down fs-5 text-warning"></i>#}
                            </div>
                            <div id="collapse-${index}" class="collapse">
                              <div class="p-3">
                                <div id="snippet-container-${index}"
                                     data-loaded="false"
                                     data-change-text="${encodeURIComponent(changeText)}">
                                  <p class="text-info">Loading snippet...</p>
                                </div>
                              </div>
                            </div>
                          </div>
                        `;

                            const cardDiv = document.createElement('div');
                            cardDiv.innerHTML = cardHTML.trim();
                            changesContainer.appendChild(cardDiv);
                        });
                        changesSection.style.display = 'block';
                        metricsSection.style.display = 'block';
                        refactoredSection.style.display = 'block';
                        resourcesSection.style.display = 'block'; // Show resources section
                        attachCardExpandHandlers(data.id); // attach snippet fetch on expand
                    }
                } else {
                    {#showToast("❌ Error in refactoring code!", "error");#}
                    showToast(`⚠️ ${data.message}`, "error");
                    showToast(`Refactoring Blocked: ${data.guideline}`, "info");
                }
            } catch (error) {
                showToast("❌ An error occurred: " + error.message, "error");
            } finally {
                loadingBar.style.display = 'none';
            }
        });

        // CHANGED #4: Query the DB or AI to get snippet diffs
        // Collapsible snippet logic
        function attachCardExpandHandlers(recordId) {
            const allCollapses = document.querySelectorAll('[id^="collapse-"]');
            allCollapses.forEach((collapseEl) => {
                // Instead of show.bs.collapse, use "shown.bs.collapse"
                collapseEl.addEventListener('shown.bs.collapse', async () => {
                    console.log("Collapsible opened => fetching snippet...");
                    const snippetContainer = collapseEl.querySelector('[id^="snippet-container-"]');
                    if (!snippetContainer) return;

                    if (snippetContainer.dataset.loaded === "true") return;

                    snippetContainer.innerHTML = `<p class="text-info">Fetching snippet diff from AI/DB...</p>`;
                    const bulletText = snippetContainer.dataset.changeText || "";
                    try {
                        const url = `/code-formatter/fetch-snippet-diff/?record_id=${recordId}&change_text=${bulletText}`;
                        const response = await fetch(url);
                        const result = await response.json();
                        if (result.success) {
                            snippetContainer.innerHTML = `
                            <p><strong>Original Snippet:</strong></p>
                            <pre class="bg-dark text-white p-2 mb-3">${result.original_snippet}</pre>
                            <p><strong>Refactored Snippet:</strong></p>
                            <pre class="bg-dark text-white p-2">${result.refactored_snippet}</pre>
                        `;
                        } else {
                            snippetContainer.innerHTML = `<p class="text-danger">Error: ${result.error}</p>`;
                        }
                        snippetContainer.dataset.loaded = "true";
                    } catch (err) {
                        snippetContainer.innerHTML = `<p class="text-danger">Failed to fetch snippet: ${err.message}</p>`;
                    }
                });
            });
        }

        // Simple toast
        {#function showToast(msg, type = "info") {#}
        {#    console.log(`[${type.toUpperCase()}] ${msg}`)}#}


        // Function to extract only the code block
        function extractCode(responseText) {
            const codeRegex = /```java([\s\S]*?)```/;
            const match = responseText.match(codeRegex);
            return match ? match[1].trim() : responseText;
        }

        // Handle File Upload
        document.querySelector('.upload-btn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) {
                return; // No file selected
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                editor.setValue(e.target.result); // Set file content in Monaco Editor
            };
            reader.readAsText(file);
        });

        // Function to download the refactored code as a file
        document.getElementById('download-btn').addEventListener('click', function () {
            const refactoredCode = refactoredEditor.getValue(); // Get the text from the editor

            if (!refactoredCode) {
                {#alert("No refactored code available to download.");#}
                showToast("⚠️ Warning: No refactored code available to download.", "warning");
                return;
            }

            const blob = new Blob([refactoredCode], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'refactored_code.java';  // Save as .java file
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        document.getElementById('fetch-github-btn').addEventListener('click', async () => {
            const repoUrl = document.getElementById('repo-url').value.trim();
            const filePath = document.getElementById('file-path').value.trim();

            if (!repoUrl || !filePath) {
                {#alert('Please enter both the GitHub repository URL and the file path.');#}
                showToast("⚠️ Warning: Please enter both the GitHub repository URL and the file path.", "warning");


                return;
            }

            // ✅ Improved regex to correctly extract owner and repo name
            const repoMatch = repoUrl.match(/github\.com\/([^/]+)\/([^/.]+)/);
            if (!repoMatch) {
                {#alert('Invalid GitHub repository URL.');#}
                showToast("❌Invalid GitHub repository URL.", "error");
                return;
            }

            const owner = repoMatch[1];
            let repo = repoMatch[2];

            // ✅ Ensure .git is removed from repo name
            repo = repo.replace(/\.git$/, "");

            // ✅ Correct API URL format
            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

            // Fetch GitHub Token
            const githubToken = await fetchGithubToken();
            if (!githubToken) {
                {#alert("Error fetching GitHub token. Please check your backend.");#}
                showToast("❌Error fetching GitHub token. Please check your backend.", "error");
                return;
            }

            try {
                const response = await fetch(apiUrl, {
                    headers: {'Authorization': `token ${githubToken}`}
                });

                if (!response.ok) {
                    throw new Error(`GitHub API Error: ${response.statusText}`);
                }

                const data = await response.json();
                const fileContent = atob(data.content);  // Decode Base64 content

                // Set the fetched code into Monaco Editor
                editor.setValue(fileContent);
                {#alert('Code successfully fetched from GitHub!');#}
                showToast("✅ Code successfully fetched from GitHub!", "success");

                // Close the modal after success
                closeModal();

            } catch (error) {
                {#alert(`Error fetching file: ${error.message}`);#}
                showToast(`Error fetching file: ${error.message}`, "error");

            }
        });


        function generateChart(originalLOC, refactoredLOC, originalReadability, refactoredReadability) {
            const ctx = document.getElementById('metricsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Original LOC', 'Refactored LOC', 'Original Readability', 'Refactored Readability'],
                    datasets: [{
                        label: 'Metrics Comparison',
                        data: [originalLOC, refactoredLOC, originalReadability, refactoredReadability],
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0'],
                    }]
                }
            });
        }

        function loadModal() {
            fetch("{% url 'github_import_modal' %}")  // Django URL for modal
                .then(response => response.text())
                .then(html => {
                    document.getElementById("modal-container").innerHTML = html;
                    setTimeout(() => {
                        showModal();
                        attachFetchEvent();  // Attach event listener after modal loads
                    }, 100);
                })
                .catch(error => console.error("Error loading modal:", error));
        }

        function attachFetchEvent() {
            const fetchButton = document.getElementById("fetch-github-btn");
            if (fetchButton) {
                fetchButton.addEventListener("click", fetchGithubFile);
            } else {
                console.error("Fetch GitHub button not found!");
            }
        }

        function fetchGithubFile() {
            const repoUrl = document.getElementById("repo-url").value.trim();
            const filePath = document.getElementById("file-path").value.trim();

            if (!repoUrl || !filePath) {
                {#alert("Please enter both the GitHub repository URL and the file path.");#}
                showToast("⚠️ Warning: Please enter both the GitHub repository URL and the file path.", "warning");
                return;
            }

            // Extract user/repo from the URL
            const repoMatch = repoUrl.match(/github\.com\/([^/]+)\/([^/]+)/);
            if (!repoMatch) {
                {#alert("Invalid GitHub repository URL.");#}
                showToast("❌Invalid GitHub repository URL.", "error");
                return;
            }

            const owner = repoMatch[1];
            const repo = repoMatch[2];

            fetch("{% url 'get_github_token' %}")
                .then(response => response.json())
                .then(data => {
                    const githubToken = data.token;
                    if (!githubToken) {
                        {#alert("Error fetching GitHub token. Please check your backend.");#}
                        showToast("❌Error fetching GitHub token. Please check your backend.", "error");
                        return;
                    }

                    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

                    fetch(apiUrl, {
                        headers: {Authorization: `token ${githubToken}`},
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`GitHub API Error: ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            const fileContent = atob(data.content); // Decode Base64 content
                            editor.setValue(fileContent);
                            {#alert("Code successfully fetched from GitHub!");#}
                            showToast("Code successfully fetched from GitHub!", "success");
                            closeModal();
                        })
                        .catch(error => alert(`Error fetching file: ${error.message}`));
                })
                .catch(error => console.error("Error fetching GitHub token:", error));
        }


        function showModal() {
            const modal = document.getElementById("githubImportModal");
            if (modal) {
                modal.style.display = "flex";
            } else {
                console.error("Modal element not found!");
            }
        }

        function closeModal() {
            const modal = document.getElementById("githubImportModal");
            if (modal) {
                modal.style.display = "none";
            } else {
                console.error("Modal element not found!");
            }
        }

        async function fetchDesignPattern(code) {
            try {
                const response = await fetch('/code-formatter/get-pattern/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({code}),
                });

                const data = await response.json();
                const designPatternText = document.getElementById("design-pattern-text");
                if (response.ok && data.pattern) {
                    document.getElementById("pattern-name").innerText = data.pattern;
                    document.getElementById("suggested-pattern").style.display = "flex";

                    // Display "Design Pattern Used" section
                    {#designPatternText.innerHTML = `🔹 <strong>Design Pattern Applied:</strong> ${data.pattern}`;#}
                    {#designPatternText.style.display = 'block';#}

                    // Fetch Learning Resource for the detected pattern
                    fetchPatternDetails(data.pattern);

                } else {
                    document.getElementById("suggested-pattern").style.display = "none";
                    designPatternText.style.display = 'none';
                    resourcesSection.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching design pattern:", error);
                document.getElementById("suggested-pattern").style.display = "none";
                document.getElementById("design-pattern-text").style.display = 'none';
            }
        }


        async function fetchMetrics(recordId) {
            try {
                const response = await fetch(`/code-formatter/get-metrics/?record_id=${recordId}`);
                const result = await response.json();

                if (result.success) {
                    generateBarChart(result.metrics);
                    generatePieChart(result.metrics);
                    generateGaugeChart(result.metrics);

                    // ✅ Attach click event handlers for opening modal after charts load
                    setTimeout(() => {
                        document.getElementById("barChart").onclick = function () {
                            openMetricsModal("Code Complexity", recordId);
                        };

                        document.getElementById("pieChart").onclick = function () {
                            openMetricsModal("Readability Improvement", recordId);
                        };

                        document.getElementById("gaugeChart").onclick = function () {
                            openMetricsModal("Maintainability Index", recordId);
                        };
                    }, 500); // Adding slight delay to ensure charts are fully loaded

                } else {
                    console.error("Error fetching metrics:", result.error);
                }
            } catch (err) {
                console.error("Error fetching metrics:", err.message);
            }
        }


        document.addEventListener("DOMContentLoaded", function () {
            fetch('/code-formatter/get-metrics/')
                .then(response => response.json())
                .then(data => {
                    const metrics = data.metrics;
                    generateBarChart(metrics);
                    generatePieChart(metrics);
                    generateGaugeChart(metrics);
                })
                .catch(error => console.error('Error fetching metrics:', error));
        });

        document.addEventListener("DOMContentLoaded", function () {
            fetch('/code-formatter/get-metrics/')
                .then(response => response.json())
                .then(data => {
                    const metrics = data.metrics;
                    generateBarChart(metrics);
                    generatePieChart(metrics);
                    generateGaugeChart(metrics);
                })
                .catch(error => console.error('Error fetching metrics:', error));
        });

        function generateBarChart(metrics) {
            const ctx = document.getElementById('barChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Lines of Code (LOC)', 'Cyclomatic Complexity', 'Maintainability Index', 'Readability Score'],
                    datasets: [
                        {
                            label: 'Before Refactoring',
                            data: [metrics.before.loc, metrics.before.complexity, metrics.before.maintainability, metrics.before.readability],
                            backgroundColor: '#ff6384',
                        },
                        {
                            label: 'After Refactoring',
                            data: [metrics.after.loc, metrics.after.complexity, metrics.after.maintainability, metrics.after.readability],
                            backgroundColor: '#36a2eb',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function generatePieChart(metrics) {
            const ctx = document.getElementById('pieChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Code Reduction (%)', 'Readability Improvement (%)', 'Maintainability Boost (%)'],
                    datasets: [{
                        data: [
                            metrics.improvement.reduction,
                            metrics.improvement.readability,
                            metrics.improvement.maintainability
                        ],
                        backgroundColor: ['#ffce56', '#4bc0c0', '#9966ff']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function generateGaugeChart(metrics) {
            const ctx = document.getElementById('gaugeChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Maintainability Index'],
                    datasets: [{
                        data: [metrics.after.maintainability, 100 - metrics.after.maintainability],
                        backgroundColor: ['#4CAF50', '#ddd']
                    }]
                },
                options: {
                    circumference: 180,
                    rotation: 270,
                    cutoutPercentage: 70,
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function openModal(chartType) {
            document.getElementById("metricsModal").style.display = "flex";
            let explanation = "";

            if (chartType === 'barChart') {
                explanation = `Even though LOC increased from ${metricsData.before.loc} to ${metricsData.after.loc}, the code's maintainability index improved due to better structure and modularization.`;
            } else if (chartType === 'pieChart') {
                explanation = `Readability improved by ${metricsData.improvement.readability}% and maintainability increased by ${metricsData.improvement.maintainability}%. These enhancements ensure better long-term maintenance.`;
            }

            document.getElementById("modal-explanation").innerText = explanation;
        }

        function closeModal() {
            document.getElementById("metricsModal").style.display = "none";
        }

        async function openMetricsModal(metricType, recordId) {
            document.getElementById("codeMetricsModal").style.display = "flex";
            document.getElementById("modal-chart-container").innerHTML = `<canvas id="modalChart"></canvas>`;
            document.getElementById("explanation-content").innerHTML = `<p>Loading explanation...</p>`;

            try {
                // Fetch Code Metrics
                const metricsResponse = await fetch(`/code-formatter/get-metrics/?record_id=${recordId}`);
                const metricsData = await metricsResponse.json();

                // Fetch Code Snippet Diff
                const diffResponse = await fetch(`/code-formatter/fetch-snippet-diff/?record_id=${recordId}`);
                const diffData = await diffResponse.json();

                if (!metricsData.success || !diffData.success) {
                    throw new Error("Failed to fetch metrics or code differences.");
                }

                // Prepare payload for explanation API
                const payload = {
                    record_id: recordId,
                    metrics: metricsData.metrics,  // Pass entire metrics object
                    original_code: diffData.original_code,
                    refactored_code: diffData.refactored_code
                };

                // Fetch AI-generated explanation
                const explanationResponse = await fetch("/code-formatter/generate-explanation/", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(payload),
                });

                const explanationData = await explanationResponse.json();

                if (!explanationData.success) {
                    throw new Error("Failed to generate explanation.");
                }

                // Update Explanation Text
                document.getElementById("explanation-content").innerHTML = `<p>${explanationData.explanation}</p>`;

                // Render the correct chart in modal
                renderModalChart(metricType, metricsData.metrics);

            } catch (error) {
                document.getElementById("explanation-content").innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
            }
        }


        function closeMetricsModal() {
            document.getElementById("codeMetricsModal").style.display = "none";
        }

        function renderModalChart(metricType, metrics) {
            const ctx = document.getElementById('modalChart').getContext('2d');

            let chartData;
            let chartType = "bar"; // Default to bar chart

            if (metricType === "Code Complexity") {
                chartData = {
                    labels: ["Before Refactoring", "After Refactoring"],
                    datasets: [{
                        label: metricType,
                        data: [metrics.before.complexity, metrics.after.complexity],
                        backgroundColor: ['#ff6384', '#36a2eb']
                    }]
                };
            } else if (metricType === "Readability Improvement") {
                chartData = {
                    labels: ["Readability Before", "Readability After"],
                    datasets: [{
                        label: metricType,
                        data: [metrics.before.readability, metrics.after.readability],
                        backgroundColor: ['#ffce56', '#4bc0c0']
                    }]
                };
            } else if (metricType === "Maintainability Index") {
                chartType = "doughnut"; // Change chart type
                chartData = {
                    labels: ["Maintainability Index"],
                    datasets: [{
                        data: [metrics.after.maintainability, 100 - metrics.after.maintainability],
                        backgroundColor: ['#4CAF50', '#ddd']
                    }]
                };
            }

            new Chart(ctx, {
                type: chartType,
                data: chartData,
                options: {responsive: true}
            });
        }

        async function fetchPatternDetails(pattern) {
            try {
                const response = await fetch('/code-formatter/get-pattern-details/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({pattern}),
                });

                const data = await response.json();

                if (response.ok && data.pattern) {
                    document.getElementById("pattern-name-text").innerText = data.pattern;
                    document.getElementById("pattern-category").innerText = data.category;
                    document.getElementById("pattern-description").innerText = data.description;
                    document.getElementById("pattern-link").href = data.link;
                } else {
                    document.getElementById("resources-section").style.display = "none";
                }
            } catch (error) {
                console.error("Error fetching pattern details:", error);
            }
        }


    </script>
    <style>
        /* Monaco Editor Full Size */
        .editor-container {
            width: 100%;
            height: calc(100vh - 200px); /* Adjust dynamically */
            border-radius: 5px;
            overflow: visible !important; /* Allow suggestions to expand freely */
        }

        /* Fix Sidebar Button Style */
        .upload-btn {
            display: flex;
            align-items: center;
            text-decoration: none;
            padding: 10px 15px;
            color: white;
        }

        /* Ensure Upload Code button matches others without the hover effect */
        .upload-btn:hover {
            background: none !important;
            border-radius: 0 !important;
        }

        /* Prevent horizontal scrolling */
        html, body {
            overflow-x: hidden;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 25px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 17px;
            width: 17px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(25px);
        }

        /* Changes Made Section */
        #changes-section {
            background-color: #1c1c1e;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        #changes-section h4 {
            color: #ffce56;
            margin-bottom: 10px;
        }

        #changes-list {
            list-style-type: none;
            padding-left: 15px;
        }

        #changes-list li {
            color: #ffffff;
            font-size: 14px;
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
        }

        #changes-list li::before {
            content: "•";
            color: #36a2eb;
            font-size: 18px;
            position: absolute;
            left: 0;
            top: 1px;
        }


        /* The "sleek-card" gradient from your previous code */
        /* Shiny Blue Background for Sleek Cards */
        .sleek-card {
            background: linear-gradient(135deg, #1e3c72, #2a5298); /* Deep blue gradient */
            border: 1px solid #4a90e2; /* Light blue border */
            color: #fff;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.6); /* Subtle blue glow */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        /* Slight hover effect */
        .sleek-card:hover {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(74, 144, 226, 0.8); /* Stronger glow on hover */
        }

        /* Ensure text remains readable */
        .sleek-card .fs-6 {
            color: #fff; /* White text for contrast */
        }

        .sleek-card .card-header {
            border-bottom: 1px solid #444;
            background: none; /* let the gradient show */
            z-index: 2; /* above the accent-shape */
        }

        .sleek-card .card-body {
            background-color: transparent;
            z-index: 2;
            position: relative;
        }

        /* Ensure the text area is above the shape */
        .sleek-card .d-flex {
            position: relative;
            z-index: 2; /* text above shape */
        }

        /* Make the clickable row have pointer cursor */
        .clickable-row {
            cursor: pointer;
        }

        /* Buttons */
        .refactor-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: auto;
            padding: 10px;
            font-size: 18px;
            background: linear-gradient(90deg, #ff758c, #ff7eb3);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: 0.3s ease;
        }

        .refactor-btn:hover {
            background: linear-gradient(90deg, #ff5a8a, #ff6ea3);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            border-radius: 25px;
            transition: 0.4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 17px;
            width: 17px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(25px);
        }

        /* General Page Styles */
        body {
            background-color: #1c1c1e;
            color: #fff;
            font-family: 'Poppins', sans-serif;
        }

        .content-wrapper {
            padding: 40px;
            max-width: 1200px;
            margin: auto;
        }

        .page-title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        /* Modernized Suggested Pattern Badge */
        .pattern-badge {
            background: linear-gradient(135deg, #6a11cb, #2575fc); /* Sleek gradient */
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease-in-out;
        }

        .pattern-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .badge-text {
            color: #fff;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        .pattern-name {
            font-weight: bold;
            color: #ffeb3b; /* Bright gold for contrast */
            font-size: 18px;
        }

        #metrics-section {
            padding: 20px;
            border-radius: 10px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        canvas {
            max-height: 400px;
        }

        .custom-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }


        .close-btn {
            color: white;
            float: right;
            font-size: 28px;
            cursor: pointer;
        }

        .custom-modal-content {
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
            width: 900px; /* Increase width */
            max-width: 90%;
            text-align: center;
            color: white;
        }

        #explanation-content {
            text-align: left;
            font-size: 16px;
            padding: 10px;
            background: #1c1c1e;
            border-radius: 5px;
            color: #ddd;
        }

        /* ✨ Modern Glassy Card UI for Learning Resources */
        .resource-card {
            background: rgba(20, 20, 20, 0.85); /* Dark semi-transparent */
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0px 0px 12px rgba(0, 255, 255, 0.3); /* Neon glow */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            width: 100%;
            max-width: 420px;
            margin: auto;
            text-align: left;
            position: relative;
            backdrop-filter: blur(10px); /* Glass effect */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ✨ Soft Glow on Hover */
        .resource-card:hover {
            transform: scale(1.03);
            box-shadow: 0px 0px 20px rgba(0, 255, 255, 0.6);
        }

        /* Header with Modern Font */
        .resource-header {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #0ef; /* Neon Cyan */
        }

        /* Icons for Better Readability */
        .resource-content p {
            font-size: 14px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .resource-content i {
            color: #0ef; /* Neon Cyan Icons */
        }

        /* 🟢 Learn More Button - Futuristic Style */
        .resource-btn {
            display: inline-block;
            padding: 10px 18px;
            background: linear-gradient(90deg, #00d4ff, #007bff); /* Cool gradient */
            color: white;
            font-weight: bold;
            border-radius: 8px;
            text-decoration: none;
            transition: background 0.3s ease-in-out, transform 0.2s;
            box-shadow: 0px 0px 8px rgba(0, 255, 255, 0.4);
            text-align: center;
            width: 100%;
            display: block;
        }

        /* 🚀 Button Hover Effect */
        .resource-btn:hover {
            background: linear-gradient(90deg, #007bff, #00d4ff);
            transform: scale(1.05);
            box-shadow: 0px 0px 15px rgba(0, 255, 255, 0.8);
        }

        .dots-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .dots-loader span {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        /* Assign different colors to each dot */
        .dots-loader .red {
            background-color: #ff4d4d; /* Red */
            animation-delay: -0.32s;
        }

        .dots-loader .yellow {
            background-color: #ffd700; /* Yellow */
            animation-delay: -0.16s;
        }

        .dots-loader .green {
            background-color: #4caf50; /* Green */
            animation-delay: 0s;
        }

        .dots-loader .blue {
            background-color: #1e90ff; /* Blue */
            animation-delay: 0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }


    </style>
{% endblock %}
