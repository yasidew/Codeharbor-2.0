{% extends 'base.html' %}
{% load static %}

{% block title %}Accessibility Checker{% endblock %}

{% block content %}
<style>
    .section-header {
        text-align: center;
        margin-bottom: 30px;
        color: #ffffff;
    }

    .card-dark {
        background-color: #1c1b29;
        color: #ffffff;
        border: 1px solid #2a2a3c;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .form-control-dark {
        background-color: #2a2840;
        color: #ffffff;
        border: 1px solid #555;
    }

    .form-control-dark::placeholder {
        color: #aaa;
    }

    .btn-primary {
        background: linear-gradient(to right, #1e90ff, #007bff);
        border: none;
        font-weight: 600;
    }

    .btn-primary:hover {
        background: linear-gradient(to right, #0056b3, #003d80);
    }

    #monaco-editor {
        height: 400px;
        border: 1px solid #333;
    }

    #loading-indicator {
        display: none;
        text-align: center;
        margin-top: 20px;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        color: #00cfff;
    }
</style>

<div class="section-header">
    <h2 class="display-5">Accessibility Checker</h2>
    <p>Submit your HTML and select WCAG guidelines to evaluate compliance.</p>
</div>

<div class="card-dark">
    <form id="accessibilityForm" method="post">
        {% csrf_token %}
        <div class="mb-3">
            <label class="form-label">Paste your HTML code:</label>
            <div id="monaco-editor"></div>
        </div>

        <div class="mb-3">
            <label for="guidelines" class="form-label">Select Guidelines (e.g. 1, 2, 3):</label>
            <input type="text" id="guidelines" name="guidelines" class="form-control form-control-dark" placeholder="Comma-separated guideline numbers like 1,2,3">
        </div>

        <button type="submit" class="btn btn-primary w-100">Evaluate Accessibility</button>
    </form>
</div>

<!-- Result Section -->
<div id="result-section" class="card-dark" style="display: none;">
    <h4>Evaluation Results</h4>

    <!-- Loading Spinner -->
    <div id="loading-indicator">
        <div class="spinner-border" role="status"></div>
        <p style="color: #ccc;">Evaluating HTML against selected guidelines‚Ä¶</p>
    </div>

    <!-- Chart + Scores -->
    <div class="row mt-4">
        <div class="col-md-6">
            <canvas id="scorePieChart" width="400" height="300"></canvas>
            <div id="score-labels" class="mt-3 text-white">
                <p><strong>Cognitive Score:</strong> <span id="cognitive-score-text">-</span>/10</p>
                <p><strong>Visual Score:</strong> <span id="visual-score-text">-</span>/10</p>
            </div>
        </div>
        <div class="col-md-6">
            <h5>Guideline Scores</h5>
            <ul id="guideline-scores-list" style="list-style-type: none; padding-left: 0;"></ul>
        </div>
    </div>

    <!-- Suggestions -->
    <div id="result-output" class="mt-4"></div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let editor;
    let pieChartInstance = null;

    require.config({ paths: { vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs" } });
    require(["vs/editor/editor.main"], function () {
        editor = monaco.editor.create(document.getElementById("monaco-editor"), {
            value: "<!-- Paste your HTML code here -->",
            language: "html",
            theme: "vs-dark",
            automaticLayout: true
        });
    });

    document.getElementById("accessibilityForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const html_code = editor.getValue();
        const guidelineInput = document.getElementById("guidelines").value.trim();
        const guidelines = guidelineInput.split(",").map(x => x.trim());

        const payload = { html_code, guidelines };

        const resultBox = document.getElementById("result-output");
        const loading = document.getElementById("loading-indicator");
        const resultSection = document.getElementById("result-section");

        resultBox.innerHTML = "";
        document.getElementById("guideline-scores-list").innerHTML = "";
        resultSection.style.display = "block";
        loading.style.display = "block";

        try {
            const response = await fetch("/api/evaluate/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            loading.style.display = "none";

            console.log("üìã Accessibility Evaluation Result:", data);

            if (data.error) {
                resultBox.innerHTML = `<p class="text-danger">${data.error}</p>`;
                return;
            }

            // ‚ú® Update scores next to chart
            document.getElementById("cognitive-score-text").textContent = data.cognitive_score ?? "-";
            document.getElementById("visual-score-text").textContent = data.visual_score ?? "-";

            // ‚ú® Populate guideline scores
            const scoreListHTML = Object.entries(data.evaluations)
                .map(([key, val]) => {
                    const scoreColor = val.score === "10/10" ? "lightgreen" : (val.score === "N/A" ? "#ccc" : "orange");
                    return `
                        <li style="margin-bottom: 1rem;">
                            <strong>Guideline ${key}:</strong><br>
                            Relevant: <span style="color:${val.relevant === 'Yes' ? 'lightgreen' : 'red'}">${val.relevant}</span><br>
                            Score: <span style="color:${scoreColor}">${val.score}</span>
                        </li>
                    `;
                })
                .join("");
            document.getElementById("guideline-scores-list").innerHTML = scoreListHTML;

            // ‚ú® Render Pie Chart
            const ctx = document.getElementById("scorePieChart").getContext("2d");
            if (pieChartInstance) pieChartInstance.destroy();
            pieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Cognitive (%)', 'Visual (%)'],
                    datasets: [{
                        data: [
                            Number(data.cognitive_score) * 10 || 0,
                            Number(data.visual_score) * 10 || 0
                        ],
                        backgroundColor: ['#36a2eb', '#ff6384'],
                        borderColor: ['#1e3a5f', '#5f1e3a'],
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });

            // ‚ú® Render Suggestions
            resultBox.innerHTML = `
                <h5 class="mt-4">Suggestions</h5>
                <ul>
                    ${data.suggestions.map(s => `
                        <li style="margin-bottom: 1.5rem;">
                            <strong>Guideline ${s.guideline}:</strong>
                            <pre style="margin-top: 0.5rem; font-family: 'Courier New', monospace;
                                        background-color: #2c2c3b; color: #f1f1f1; padding: 12px;
                                        border-radius: 8px; white-space: pre-wrap; line-height: 1.6; overflow-x: auto;">
${s.suggestion.replace(/</g, "&lt;").replace(/>/g, "&gt;")}
                            </pre>
                        </li>
                    `).join("")}
                </ul>
            `;
        } catch (err) {
            loading.style.display = "none";
            console.error("‚ùå Error in fetching evaluation:", err);
        }
    });
</script>
{% endblock %}
