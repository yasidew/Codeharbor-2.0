{% extends 'base.html' %}
{% load static %}

{% block title %}Accessibility Checker{% endblock %}

{% block content %}
    
    {% block sidebar %}
    <div class="sidebar" data-color="black">
        <div class="sidebar-wrapper">
            <div class="logo">
                <a href="http://127.0.0.1:8000" class="simple-text logo-mini">
                    <img src="{% static 'images/code-harbor-logo.png' %}" alt="Code Harbor Logo" width="30">
                </a>
                <a href="http://127.0.0.1:8000" class="simple-text logo-normal">Code Harbor</a>
            </div>
            <ul class="nav">
                <li>
                    <a href="{% url 'add_resource' %}"><i class="bi bi-person-circle"></i>
                        <p>Profile</p>
                    </a>
                </li>
                <li><a href="http://127.0.0.1:8000/games/github-scraper/"><i class="bi bi-controller"></i>
                    <p>Accessibility Challenges</p></a></li>
                <li>
                    <a href="#" class="upload-btn"><i class="bi bi-upload"></i>
                        <p>Upload Code</p>
                    </a>
                    <input type="file" name="file" id="fileInput" class="d-none">
                </li>
                <li><a href="{% url 'define_guidelines' %}"><i class="bi bi-globe"></i>
                    <p>Upload URL</p></a></li>
               
                <li><a href="http://127.0.0.1:8000/api/submit/"><i class="bi bi-shield-check"></i>
                    <p>Accessiblity Evaluator</p></a></li>
                <!-- ‚úÖ Add Resources with a proper icon -->
                

                <li><a href="#"><i class="bi bi-gear"></i>
                    <p>Settings</p></a></li>
                <li><a href="#"><i class="bi bi-box-arrow-right"></i>
                    <p>Logout</p></a></li>
            </ul>
        </div>
    </div>
{% endblock %}
    
<style>
    .section-header {
        text-align: center;
        margin-bottom: 30px;
        color: #ffffff;
    }

    .card-dark {
        background-color: #1c1b29;
        color: #ffffff;
        border: 1px solid #2a2a3c;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .form-control-dark {
        background-color: #2a2840;
        color: #ffffff;
        border: 1px solid #555;
    }

    .form-control-dark::placeholder {
        color: #aaa;
    }

    .btn-primary {
        background: linear-gradient(to right, #1e90ff, #007bff);
        border: none;
        font-weight: 600;
    }

    .btn-primary:hover {
        background: linear-gradient(to right, #0056b3, #003d80);
    }

    #monaco-editor {
        height: 400px;
        border: 1px solid #333;
    }

    #loading-indicator {
        display: none;
        text-align: center;
        margin-top: 20px;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        color: #00cfff;
    }
</style>

<div class="section-header">
    <h2 class="display-5">Accessibility Evaluator</h2>
    <p>Submit your HTML and select WCAG guidelines to evaluate compliance.</p>
</div>

<div class="card-dark">
    <form id="accessibilityForm" method="post">
        {% csrf_token %}
        <div class="mb-3">
            <label for="htmlFileInput" class="form-label">Upload HTML File:</label>
            <input type="file" id="htmlFileInput" class="form-control form-control-dark" accept=".html,.htm">
        </div>
        
        <div class="mb-3">
            <label for="urlInput" class="form-label">Enter Webpage URL:</label>
            <div class="d-flex">
                <input type="url" id="urlInput" class="form-control form-control-dark me-2" placeholder="https://example.com">
                <button id="fetchHtmlBtn" type="button" class="btn btn-primary">Fetch & Inject</button>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Paste your HTML code:</label>
            <div id="monaco-editor"></div>
        </div>

        <div class="mb-3">
            <label for="guidelines" class="form-label">Select Guidelines (e.g. 1, 2, 3):</label>
            <input type="text" id="guidelines" name="guidelines" class="form-control form-control-dark"
                   placeholder="Comma-separated guideline numbers like 1,2,3">
        </div>

        <button type="submit" class="btn btn-primary w-100">Evaluate Accessibility</button>
    </form>
</div>

<!-- Result Section -->
<div id="result-section" class="card-dark" style="display: none;">
    <h4>Evaluation Results</h4>

    <div id="loading-indicator">
        <div class="spinner-border" role="status"></div>
        <p style="color: #ccc;">Evaluating HTML against selected guidelines‚Ä¶</p>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <canvas id="scorePieChart" width="400" height="300"></canvas>
            <div id="score-labels" class="mt-3 text-white">
                <p><strong>Cognitive Score:</strong> <span id="cognitive-score-text">-</span>/10</p>
                <p><strong>Visual Score:</strong> <span id="visual-score-text">-</span>/10</p>
            </div>
        </div>
        <div class="col-md-6">
            <h5>Guideline Scores</h5>
            <ul id="guideline-scores-list" style="list-style-type: none; padding-left: 0;"></ul>
        </div>
    </div>

    <div id="result-output" class="mt-4"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let editor;
    let pieChartInstance = null;

    require.config({ paths: { vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs" } });
    require(["vs/editor/editor.main"], function () {
        editor = monaco.editor.create(document.getElementById("monaco-editor"), {
            value: "<!-- Paste your HTML code here -->",
            language: "html",
            theme: "vs-dark",
            automaticLayout: true
        });
    });

    document.getElementById("htmlFileInput").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        if (!file.name.endsWith(".html") && !file.name.endsWith(".htm")) {
            alert("Please upload a valid HTML file (.html or .htm).");
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const fileContent = e.target.result;
            editor.setValue(fileContent);
            console.log("üì• Loaded HTML file into Monaco Editor.");
        };
        reader.readAsText(file);
    });

    document.getElementById("fetchHtmlBtn").addEventListener("click", async function () {
        const url = document.getElementById("urlInput").value.trim();
        if (!url) {
            alert("Please enter a valid URL.");
            return;
        }

        try {
            const response = await fetch("/api/fetch-html/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ url })
            });

            const data = await response.json();

            if (data.error) {
                alert("Error: " + data.error);
                return;
            }

            if (editor && data.html) {
                editor.setValue(data.html);
                console.log("üåê HTML loaded from URL.");
            }
        } catch (err) {
            console.error("‚ùå Failed to fetch HTML from URL:", err);
            alert("Failed to load content. Please try again.");
        }
    });

    document.getElementById("accessibilityForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const html_code = editor.getValue();
        const guidelineInput = document.getElementById("guidelines").value.trim();
        const guidelines = guidelineInput.split(",").map(x => x.trim());

        const payload = { html_code, guidelines };

        const resultBox = document.getElementById("result-output");
        const loading = document.getElementById("loading-indicator");
        const resultSection = document.getElementById("result-section");

        resultBox.innerHTML = "";
        document.getElementById("guideline-scores-list").innerHTML = "";
        document.getElementById("cognitive-score-text").textContent = "-";
        document.getElementById("visual-score-text").textContent = "-";

        if (pieChartInstance) {
            pieChartInstance.destroy();
            pieChartInstance = null;
        }
        const ctx = document.getElementById("scorePieChart").getContext("2d");
        ctx.clearRect(0, 0, 400, 300);

        resultSection.style.display = "block";
        loading.style.display = "block";

        try {
            const response = await fetch("/api/evaluate/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            loading.style.display = "none";

            if (data.error) {
                resultBox.innerHTML = `<p class="text-danger">${data.error}</p>`;
                return;
            }

            document.getElementById("cognitive-score-text").textContent = data.cognitive_score ?? "-";
            document.getElementById("visual-score-text").textContent = data.visual_score ?? "-";

            const scoreListHTML = Object.entries(data.scores || {})
                .map(([key, val]) => {
                    const scoreColor = val === "10/10" ? "lightgreen" : (val === "N/A" ? "#ccc" : "orange");
                    return `
                        <li style="margin-bottom: 1rem;">
                            <strong>Guideline ${key}:</strong><br>
                            Score: <span style="color:${scoreColor}">${val}</span>
                        </li>
                    `;
                })
                .join("");
            document.getElementById("guideline-scores-list").innerHTML = scoreListHTML;

            pieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Cognitive (%)', 'Visual (%)'],
                    datasets: [{
                        data: [
                            Number(data.cognitive_score) * 10 || 0,
                            Number(data.visual_score) * 10 || 0
                        ],
                        backgroundColor: ['#36a2eb', '#ff6384'],
                        borderColor: ['#1e3a5f', '#5f1e3a'],
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });

            if (data.suggestions && data.suggestions.length > 0) {
                resultBox.innerHTML = `
                    <h5 class="mt-4">Suggestions</h5>
                    <ul>
                        ${data.suggestions.map(s => `
                            <li style="margin-bottom: 1.5rem;">
                                <strong>Guideline ${s.guideline}:</strong>
                                <pre style="margin-top: 0.5rem; font-family: 'Courier New', monospace;
                                            background-color: #2c2c3b; color: #f1f1f1; padding: 12px;
                                            border-radius: 8px; white-space: pre-wrap; line-height: 1.6; overflow-x: auto;">
${s.suggestion.replace(/</g, "&lt;").replace(/>/g, "&gt;")}
                                </pre>
                            </li>
                        `).join("")}
                    </ul>
                `;
            } else {
                resultBox.innerHTML = `<p class="text-warning">No suggestions were generated.</p>`;
            }

        } catch (err) {
            loading.style.display = "none";
            console.error("‚ùå Error fetching evaluation:", err);
        }
    });
</script>
{% endblock %}
